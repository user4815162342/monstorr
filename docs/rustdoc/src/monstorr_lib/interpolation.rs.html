<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="generator" content="rustdoc"><meta name="description" content="Source of the Rust file `monstorr-lib/src/interpolation.rs`."><meta name="keywords" content="rust, rustlang, rust-lang"><title>interpolation.rs - source</title><link rel="preload" as="font" type="font/woff2" crossorigin href="../../SourceSerif4-Regular.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../FiraSans-Regular.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../FiraSans-Medium.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../SourceCodePro-Regular.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../SourceSerif4-Bold.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../SourceCodePro-Semibold.ttf.woff2"><link rel="stylesheet" type="text/css" href="../../normalize.css"><link rel="stylesheet" type="text/css" href="../../rustdoc.css" id="mainThemeStyle"><link rel="stylesheet" type="text/css" href="../../ayu.css" disabled><link rel="stylesheet" type="text/css" href="../../dark.css" disabled><link rel="stylesheet" type="text/css" href="../../light.css" id="themeStyle"><script id="default-settings" ></script><script src="../../storage.js"></script><script src="../../crates.js"></script><script defer src="../../main.js"></script><script defer src="../../source-script.js"></script><script defer src="../../source-files.js"></script>
    <noscript><link rel="stylesheet" href="../../noscript.css"></noscript><link rel="alternate icon" type="image/png" href="../../favicon-16x16.png"><link rel="alternate icon" type="image/png" href="../../favicon-32x32.png"><link rel="icon" type="image/svg+xml" href="../../favicon.svg"></head><body class="rustdoc source"><!--[if lte IE 11]><div class="warning">This old browser is unsupported and will most likely display funky things.</div><![endif]--><nav class="mobile-topbar"><button class="sidebar-menu-toggle">&#9776;</button><a class="sidebar-logo" href="../../monstorr_lib/index.html"><div class="logo-container"><img class="rust-logo" src="../../rust-logo.svg" alt="logo"></div>
        </a><h2 class="location"></h2>
    </nav>
    <nav class="sidebar"><a class="sidebar-logo" href="../../monstorr_lib/index.html"><div class="logo-container"><img class="rust-logo" src="../../rust-logo.svg" alt="logo"></div>
        </a></nav><main><div class="width-limiter"><div class="sub-container"><a class="sub-logo-container" href="../../monstorr_lib/index.html"><img class="rust-logo" src="../../rust-logo.svg" alt="logo"></a><nav class="sub"><div class="theme-picker hidden"><button id="theme-picker" aria-label="Pick another theme!" aria-haspopup="menu" title="themes"><img width="22" height="22" alt="Pick another theme!" src="../../brush.svg"></button><div id="theme-choices" role="menu"></div></div><form class="search-form"><div class="search-container"><span></span><input class="search-input" name="search" autocomplete="off" spellcheck="false" placeholder="Click or press ‘S’ to search, ‘?’ for more options…" type="search"><button type="button" id="help-button" title="help">?</button><a id="settings-menu" href="../../settings.html" title="settings"><img width="22" height="22" alt="Change settings" src="../../wheel.svg"></a></div></form></nav></div><section id="main-content" class="content"><div class="example-wrap"><pre class="line-numbers"><span id="1">1</span>
<span id="2">2</span>
<span id="3">3</span>
<span id="4">4</span>
<span id="5">5</span>
<span id="6">6</span>
<span id="7">7</span>
<span id="8">8</span>
<span id="9">9</span>
<span id="10">10</span>
<span id="11">11</span>
<span id="12">12</span>
<span id="13">13</span>
<span id="14">14</span>
<span id="15">15</span>
<span id="16">16</span>
<span id="17">17</span>
<span id="18">18</span>
<span id="19">19</span>
<span id="20">20</span>
<span id="21">21</span>
<span id="22">22</span>
<span id="23">23</span>
<span id="24">24</span>
<span id="25">25</span>
<span id="26">26</span>
<span id="27">27</span>
<span id="28">28</span>
<span id="29">29</span>
<span id="30">30</span>
<span id="31">31</span>
<span id="32">32</span>
<span id="33">33</span>
<span id="34">34</span>
<span id="35">35</span>
<span id="36">36</span>
<span id="37">37</span>
<span id="38">38</span>
<span id="39">39</span>
<span id="40">40</span>
<span id="41">41</span>
<span id="42">42</span>
<span id="43">43</span>
<span id="44">44</span>
<span id="45">45</span>
<span id="46">46</span>
<span id="47">47</span>
<span id="48">48</span>
<span id="49">49</span>
<span id="50">50</span>
<span id="51">51</span>
<span id="52">52</span>
<span id="53">53</span>
<span id="54">54</span>
<span id="55">55</span>
<span id="56">56</span>
<span id="57">57</span>
<span id="58">58</span>
<span id="59">59</span>
<span id="60">60</span>
<span id="61">61</span>
<span id="62">62</span>
<span id="63">63</span>
<span id="64">64</span>
<span id="65">65</span>
<span id="66">66</span>
<span id="67">67</span>
<span id="68">68</span>
<span id="69">69</span>
<span id="70">70</span>
<span id="71">71</span>
<span id="72">72</span>
<span id="73">73</span>
<span id="74">74</span>
<span id="75">75</span>
<span id="76">76</span>
<span id="77">77</span>
<span id="78">78</span>
<span id="79">79</span>
<span id="80">80</span>
<span id="81">81</span>
<span id="82">82</span>
<span id="83">83</span>
<span id="84">84</span>
<span id="85">85</span>
<span id="86">86</span>
<span id="87">87</span>
<span id="88">88</span>
<span id="89">89</span>
<span id="90">90</span>
<span id="91">91</span>
<span id="92">92</span>
<span id="93">93</span>
<span id="94">94</span>
<span id="95">95</span>
<span id="96">96</span>
<span id="97">97</span>
<span id="98">98</span>
<span id="99">99</span>
<span id="100">100</span>
<span id="101">101</span>
<span id="102">102</span>
<span id="103">103</span>
<span id="104">104</span>
<span id="105">105</span>
<span id="106">106</span>
<span id="107">107</span>
<span id="108">108</span>
<span id="109">109</span>
<span id="110">110</span>
<span id="111">111</span>
<span id="112">112</span>
<span id="113">113</span>
<span id="114">114</span>
<span id="115">115</span>
<span id="116">116</span>
<span id="117">117</span>
<span id="118">118</span>
<span id="119">119</span>
<span id="120">120</span>
<span id="121">121</span>
<span id="122">122</span>
<span id="123">123</span>
<span id="124">124</span>
<span id="125">125</span>
<span id="126">126</span>
<span id="127">127</span>
<span id="128">128</span>
<span id="129">129</span>
<span id="130">130</span>
<span id="131">131</span>
<span id="132">132</span>
<span id="133">133</span>
<span id="134">134</span>
<span id="135">135</span>
<span id="136">136</span>
<span id="137">137</span>
<span id="138">138</span>
<span id="139">139</span>
<span id="140">140</span>
<span id="141">141</span>
<span id="142">142</span>
<span id="143">143</span>
<span id="144">144</span>
<span id="145">145</span>
<span id="146">146</span>
<span id="147">147</span>
<span id="148">148</span>
<span id="149">149</span>
<span id="150">150</span>
<span id="151">151</span>
<span id="152">152</span>
<span id="153">153</span>
<span id="154">154</span>
<span id="155">155</span>
<span id="156">156</span>
<span id="157">157</span>
<span id="158">158</span>
<span id="159">159</span>
<span id="160">160</span>
<span id="161">161</span>
<span id="162">162</span>
<span id="163">163</span>
<span id="164">164</span>
<span id="165">165</span>
<span id="166">166</span>
<span id="167">167</span>
<span id="168">168</span>
<span id="169">169</span>
<span id="170">170</span>
<span id="171">171</span>
<span id="172">172</span>
<span id="173">173</span>
<span id="174">174</span>
<span id="175">175</span>
<span id="176">176</span>
<span id="177">177</span>
<span id="178">178</span>
<span id="179">179</span>
<span id="180">180</span>
<span id="181">181</span>
<span id="182">182</span>
<span id="183">183</span>
<span id="184">184</span>
<span id="185">185</span>
<span id="186">186</span>
<span id="187">187</span>
<span id="188">188</span>
<span id="189">189</span>
<span id="190">190</span>
<span id="191">191</span>
<span id="192">192</span>
<span id="193">193</span>
<span id="194">194</span>
<span id="195">195</span>
<span id="196">196</span>
<span id="197">197</span>
<span id="198">198</span>
<span id="199">199</span>
<span id="200">200</span>
<span id="201">201</span>
<span id="202">202</span>
<span id="203">203</span>
<span id="204">204</span>
<span id="205">205</span>
<span id="206">206</span>
<span id="207">207</span>
<span id="208">208</span>
<span id="209">209</span>
<span id="210">210</span>
<span id="211">211</span>
<span id="212">212</span>
<span id="213">213</span>
<span id="214">214</span>
<span id="215">215</span>
<span id="216">216</span>
<span id="217">217</span>
<span id="218">218</span>
<span id="219">219</span>
<span id="220">220</span>
<span id="221">221</span>
<span id="222">222</span>
<span id="223">223</span>
<span id="224">224</span>
<span id="225">225</span>
<span id="226">226</span>
<span id="227">227</span>
<span id="228">228</span>
<span id="229">229</span>
<span id="230">230</span>
<span id="231">231</span>
<span id="232">232</span>
<span id="233">233</span>
<span id="234">234</span>
<span id="235">235</span>
<span id="236">236</span>
<span id="237">237</span>
<span id="238">238</span>
<span id="239">239</span>
<span id="240">240</span>
<span id="241">241</span>
<span id="242">242</span>
<span id="243">243</span>
<span id="244">244</span>
<span id="245">245</span>
<span id="246">246</span>
<span id="247">247</span>
<span id="248">248</span>
<span id="249">249</span>
<span id="250">250</span>
<span id="251">251</span>
<span id="252">252</span>
<span id="253">253</span>
<span id="254">254</span>
<span id="255">255</span>
<span id="256">256</span>
<span id="257">257</span>
<span id="258">258</span>
<span id="259">259</span>
<span id="260">260</span>
<span id="261">261</span>
<span id="262">262</span>
<span id="263">263</span>
<span id="264">264</span>
<span id="265">265</span>
<span id="266">266</span>
<span id="267">267</span>
<span id="268">268</span>
<span id="269">269</span>
<span id="270">270</span>
<span id="271">271</span>
<span id="272">272</span>
<span id="273">273</span>
<span id="274">274</span>
<span id="275">275</span>
<span id="276">276</span>
<span id="277">277</span>
<span id="278">278</span>
<span id="279">279</span>
<span id="280">280</span>
<span id="281">281</span>
<span id="282">282</span>
<span id="283">283</span>
<span id="284">284</span>
<span id="285">285</span>
<span id="286">286</span>
<span id="287">287</span>
<span id="288">288</span>
<span id="289">289</span>
<span id="290">290</span>
<span id="291">291</span>
<span id="292">292</span>
<span id="293">293</span>
<span id="294">294</span>
<span id="295">295</span>
<span id="296">296</span>
<span id="297">297</span>
<span id="298">298</span>
<span id="299">299</span>
<span id="300">300</span>
<span id="301">301</span>
<span id="302">302</span>
<span id="303">303</span>
<span id="304">304</span>
<span id="305">305</span>
<span id="306">306</span>
<span id="307">307</span>
<span id="308">308</span>
<span id="309">309</span>
<span id="310">310</span>
<span id="311">311</span>
<span id="312">312</span>
<span id="313">313</span>
<span id="314">314</span>
<span id="315">315</span>
<span id="316">316</span>
<span id="317">317</span>
<span id="318">318</span>
<span id="319">319</span>
<span id="320">320</span>
<span id="321">321</span>
<span id="322">322</span>
<span id="323">323</span>
<span id="324">324</span>
<span id="325">325</span>
<span id="326">326</span>
<span id="327">327</span>
<span id="328">328</span>
<span id="329">329</span>
<span id="330">330</span>
<span id="331">331</span>
<span id="332">332</span>
<span id="333">333</span>
<span id="334">334</span>
<span id="335">335</span>
<span id="336">336</span>
<span id="337">337</span>
<span id="338">338</span>
<span id="339">339</span>
<span id="340">340</span>
<span id="341">341</span>
<span id="342">342</span>
<span id="343">343</span>
<span id="344">344</span>
<span id="345">345</span>
<span id="346">346</span>
<span id="347">347</span>
<span id="348">348</span>
<span id="349">349</span>
<span id="350">350</span>
<span id="351">351</span>
<span id="352">352</span>
<span id="353">353</span>
<span id="354">354</span>
<span id="355">355</span>
<span id="356">356</span>
<span id="357">357</span>
<span id="358">358</span>
<span id="359">359</span>
<span id="360">360</span>
<span id="361">361</span>
<span id="362">362</span>
<span id="363">363</span>
<span id="364">364</span>
<span id="365">365</span>
<span id="366">366</span>
<span id="367">367</span>
<span id="368">368</span>
<span id="369">369</span>
<span id="370">370</span>
<span id="371">371</span>
<span id="372">372</span>
<span id="373">373</span>
<span id="374">374</span>
<span id="375">375</span>
<span id="376">376</span>
<span id="377">377</span>
<span id="378">378</span>
<span id="379">379</span>
<span id="380">380</span>
<span id="381">381</span>
<span id="382">382</span>
<span id="383">383</span>
<span id="384">384</span>
<span id="385">385</span>
<span id="386">386</span>
<span id="387">387</span>
<span id="388">388</span>
<span id="389">389</span>
<span id="390">390</span>
<span id="391">391</span>
<span id="392">392</span>
<span id="393">393</span>
<span id="394">394</span>
<span id="395">395</span>
<span id="396">396</span>
<span id="397">397</span>
<span id="398">398</span>
<span id="399">399</span>
<span id="400">400</span>
<span id="401">401</span>
<span id="402">402</span>
<span id="403">403</span>
<span id="404">404</span>
<span id="405">405</span>
<span id="406">406</span>
<span id="407">407</span>
<span id="408">408</span>
<span id="409">409</span>
<span id="410">410</span>
<span id="411">411</span>
<span id="412">412</span>
<span id="413">413</span>
<span id="414">414</span>
<span id="415">415</span>
<span id="416">416</span>
<span id="417">417</span>
<span id="418">418</span>
<span id="419">419</span>
<span id="420">420</span>
<span id="421">421</span>
<span id="422">422</span>
<span id="423">423</span>
<span id="424">424</span>
<span id="425">425</span>
<span id="426">426</span>
<span id="427">427</span>
<span id="428">428</span>
<span id="429">429</span>
<span id="430">430</span>
<span id="431">431</span>
<span id="432">432</span>
<span id="433">433</span>
<span id="434">434</span>
<span id="435">435</span>
<span id="436">436</span>
<span id="437">437</span>
<span id="438">438</span>
<span id="439">439</span>
<span id="440">440</span>
<span id="441">441</span>
<span id="442">442</span>
<span id="443">443</span>
<span id="444">444</span>
<span id="445">445</span>
<span id="446">446</span>
<span id="447">447</span>
<span id="448">448</span>
<span id="449">449</span>
<span id="450">450</span>
<span id="451">451</span>
<span id="452">452</span>
<span id="453">453</span>
<span id="454">454</span>
<span id="455">455</span>
<span id="456">456</span>
<span id="457">457</span>
<span id="458">458</span>
<span id="459">459</span>
<span id="460">460</span>
<span id="461">461</span>
<span id="462">462</span>
<span id="463">463</span>
<span id="464">464</span>
<span id="465">465</span>
<span id="466">466</span>
<span id="467">467</span>
<span id="468">468</span>
<span id="469">469</span>
<span id="470">470</span>
<span id="471">471</span>
<span id="472">472</span>
<span id="473">473</span>
<span id="474">474</span>
<span id="475">475</span>
<span id="476">476</span>
<span id="477">477</span>
<span id="478">478</span>
<span id="479">479</span>
<span id="480">480</span>
<span id="481">481</span>
<span id="482">482</span>
<span id="483">483</span>
<span id="484">484</span>
<span id="485">485</span>
<span id="486">486</span>
<span id="487">487</span>
<span id="488">488</span>
<span id="489">489</span>
<span id="490">490</span>
<span id="491">491</span>
<span id="492">492</span>
<span id="493">493</span>
<span id="494">494</span>
<span id="495">495</span>
<span id="496">496</span>
<span id="497">497</span>
<span id="498">498</span>
<span id="499">499</span>
<span id="500">500</span>
<span id="501">501</span>
<span id="502">502</span>
<span id="503">503</span>
<span id="504">504</span>
<span id="505">505</span>
<span id="506">506</span>
<span id="507">507</span>
<span id="508">508</span>
<span id="509">509</span>
<span id="510">510</span>
<span id="511">511</span>
<span id="512">512</span>
<span id="513">513</span>
<span id="514">514</span>
<span id="515">515</span>
<span id="516">516</span>
<span id="517">517</span>
<span id="518">518</span>
<span id="519">519</span>
<span id="520">520</span>
<span id="521">521</span>
<span id="522">522</span>
<span id="523">523</span>
<span id="524">524</span>
<span id="525">525</span>
<span id="526">526</span>
<span id="527">527</span>
<span id="528">528</span>
<span id="529">529</span>
<span id="530">530</span>
<span id="531">531</span>
<span id="532">532</span>
<span id="533">533</span>
<span id="534">534</span>
<span id="535">535</span>
<span id="536">536</span>
<span id="537">537</span>
<span id="538">538</span>
<span id="539">539</span>
<span id="540">540</span>
<span id="541">541</span>
<span id="542">542</span>
<span id="543">543</span>
<span id="544">544</span>
<span id="545">545</span>
<span id="546">546</span>
<span id="547">547</span>
<span id="548">548</span>
<span id="549">549</span>
<span id="550">550</span>
<span id="551">551</span>
<span id="552">552</span>
<span id="553">553</span>
<span id="554">554</span>
<span id="555">555</span>
<span id="556">556</span>
<span id="557">557</span>
<span id="558">558</span>
<span id="559">559</span>
<span id="560">560</span>
<span id="561">561</span>
<span id="562">562</span>
<span id="563">563</span>
<span id="564">564</span>
<span id="565">565</span>
<span id="566">566</span>
<span id="567">567</span>
<span id="568">568</span>
<span id="569">569</span>
<span id="570">570</span>
<span id="571">571</span>
<span id="572">572</span>
<span id="573">573</span>
<span id="574">574</span>
<span id="575">575</span>
<span id="576">576</span>
<span id="577">577</span>
<span id="578">578</span>
<span id="579">579</span>
<span id="580">580</span>
<span id="581">581</span>
<span id="582">582</span>
<span id="583">583</span>
<span id="584">584</span>
<span id="585">585</span>
<span id="586">586</span>
<span id="587">587</span>
<span id="588">588</span>
<span id="589">589</span>
<span id="590">590</span>
<span id="591">591</span>
<span id="592">592</span>
<span id="593">593</span>
<span id="594">594</span>
<span id="595">595</span>
<span id="596">596</span>
<span id="597">597</span>
<span id="598">598</span>
<span id="599">599</span>
<span id="600">600</span>
<span id="601">601</span>
<span id="602">602</span>
<span id="603">603</span>
<span id="604">604</span>
<span id="605">605</span>
<span id="606">606</span>
<span id="607">607</span>
<span id="608">608</span>
<span id="609">609</span>
<span id="610">610</span>
<span id="611">611</span>
<span id="612">612</span>
<span id="613">613</span>
<span id="614">614</span>
<span id="615">615</span>
<span id="616">616</span>
<span id="617">617</span>
<span id="618">618</span>
<span id="619">619</span>
<span id="620">620</span>
<span id="621">621</span>
<span id="622">622</span>
<span id="623">623</span>
<span id="624">624</span>
<span id="625">625</span>
<span id="626">626</span>
<span id="627">627</span>
<span id="628">628</span>
<span id="629">629</span>
<span id="630">630</span>
<span id="631">631</span>
<span id="632">632</span>
<span id="633">633</span>
<span id="634">634</span>
<span id="635">635</span>
<span id="636">636</span>
<span id="637">637</span>
<span id="638">638</span>
<span id="639">639</span>
<span id="640">640</span>
<span id="641">641</span>
<span id="642">642</span>
<span id="643">643</span>
<span id="644">644</span>
<span id="645">645</span>
<span id="646">646</span>
<span id="647">647</span>
<span id="648">648</span>
<span id="649">649</span>
<span id="650">650</span>
<span id="651">651</span>
<span id="652">652</span>
<span id="653">653</span>
<span id="654">654</span>
<span id="655">655</span>
<span id="656">656</span>
<span id="657">657</span>
<span id="658">658</span>
<span id="659">659</span>
<span id="660">660</span>
<span id="661">661</span>
<span id="662">662</span>
<span id="663">663</span>
<span id="664">664</span>
<span id="665">665</span>
<span id="666">666</span>
<span id="667">667</span>
<span id="668">668</span>
<span id="669">669</span>
<span id="670">670</span>
<span id="671">671</span>
<span id="672">672</span>
<span id="673">673</span>
<span id="674">674</span>
<span id="675">675</span>
<span id="676">676</span>
<span id="677">677</span>
<span id="678">678</span>
<span id="679">679</span>
<span id="680">680</span>
<span id="681">681</span>
<span id="682">682</span>
<span id="683">683</span>
<span id="684">684</span>
<span id="685">685</span>
<span id="686">686</span>
<span id="687">687</span>
<span id="688">688</span>
<span id="689">689</span>
<span id="690">690</span>
<span id="691">691</span>
<span id="692">692</span>
<span id="693">693</span>
<span id="694">694</span>
<span id="695">695</span>
<span id="696">696</span>
<span id="697">697</span>
<span id="698">698</span>
<span id="699">699</span>
<span id="700">700</span>
<span id="701">701</span>
<span id="702">702</span>
<span id="703">703</span>
<span id="704">704</span>
<span id="705">705</span>
<span id="706">706</span>
<span id="707">707</span>
<span id="708">708</span>
<span id="709">709</span>
<span id="710">710</span>
<span id="711">711</span>
<span id="712">712</span>
<span id="713">713</span>
<span id="714">714</span>
<span id="715">715</span>
<span id="716">716</span>
<span id="717">717</span>
<span id="718">718</span>
<span id="719">719</span>
<span id="720">720</span>
<span id="721">721</span>
<span id="722">722</span>
<span id="723">723</span>
<span id="724">724</span>
<span id="725">725</span>
<span id="726">726</span>
<span id="727">727</span>
<span id="728">728</span>
<span id="729">729</span>
<span id="730">730</span>
<span id="731">731</span>
<span id="732">732</span>
<span id="733">733</span>
<span id="734">734</span>
<span id="735">735</span>
<span id="736">736</span>
<span id="737">737</span>
<span id="738">738</span>
<span id="739">739</span>
<span id="740">740</span>
<span id="741">741</span>
<span id="742">742</span>
<span id="743">743</span>
<span id="744">744</span>
<span id="745">745</span>
<span id="746">746</span>
<span id="747">747</span>
<span id="748">748</span>
<span id="749">749</span>
<span id="750">750</span>
<span id="751">751</span>
<span id="752">752</span>
<span id="753">753</span>
<span id="754">754</span>
<span id="755">755</span>
<span id="756">756</span>
<span id="757">757</span>
<span id="758">758</span>
<span id="759">759</span>
<span id="760">760</span>
<span id="761">761</span>
<span id="762">762</span>
<span id="763">763</span>
<span id="764">764</span>
<span id="765">765</span>
<span id="766">766</span>
<span id="767">767</span>
<span id="768">768</span>
<span id="769">769</span>
<span id="770">770</span>
<span id="771">771</span>
<span id="772">772</span>
<span id="773">773</span>
<span id="774">774</span>
<span id="775">775</span>
<span id="776">776</span>
<span id="777">777</span>
<span id="778">778</span>
<span id="779">779</span>
<span id="780">780</span>
<span id="781">781</span>
<span id="782">782</span>
<span id="783">783</span>
<span id="784">784</span>
<span id="785">785</span>
<span id="786">786</span>
<span id="787">787</span>
<span id="788">788</span>
<span id="789">789</span>
<span id="790">790</span>
<span id="791">791</span>
<span id="792">792</span>
<span id="793">793</span>
<span id="794">794</span>
<span id="795">795</span>
<span id="796">796</span>
<span id="797">797</span>
<span id="798">798</span>
<span id="799">799</span>
<span id="800">800</span>
<span id="801">801</span>
<span id="802">802</span>
<span id="803">803</span>
<span id="804">804</span>
<span id="805">805</span>
<span id="806">806</span>
<span id="807">807</span>
<span id="808">808</span>
<span id="809">809</span>
<span id="810">810</span>
<span id="811">811</span>
<span id="812">812</span>
<span id="813">813</span>
<span id="814">814</span>
<span id="815">815</span>
<span id="816">816</span>
<span id="817">817</span>
<span id="818">818</span>
<span id="819">819</span>
<span id="820">820</span>
<span id="821">821</span>
<span id="822">822</span>
<span id="823">823</span>
<span id="824">824</span>
<span id="825">825</span>
<span id="826">826</span>
<span id="827">827</span>
<span id="828">828</span>
<span id="829">829</span>
<span id="830">830</span>
<span id="831">831</span>
<span id="832">832</span>
<span id="833">833</span>
<span id="834">834</span>
<span id="835">835</span>
<span id="836">836</span>
<span id="837">837</span>
<span id="838">838</span>
<span id="839">839</span>
<span id="840">840</span>
<span id="841">841</span>
<span id="842">842</span>
<span id="843">843</span>
<span id="844">844</span>
<span id="845">845</span>
<span id="846">846</span>
<span id="847">847</span>
<span id="848">848</span>
<span id="849">849</span>
<span id="850">850</span>
<span id="851">851</span>
<span id="852">852</span>
<span id="853">853</span>
<span id="854">854</span>
<span id="855">855</span>
<span id="856">856</span>
<span id="857">857</span>
<span id="858">858</span>
<span id="859">859</span>
<span id="860">860</span>
<span id="861">861</span>
<span id="862">862</span>
<span id="863">863</span>
<span id="864">864</span>
<span id="865">865</span>
<span id="866">866</span>
<span id="867">867</span>
<span id="868">868</span>
<span id="869">869</span>
<span id="870">870</span>
<span id="871">871</span>
<span id="872">872</span>
<span id="873">873</span>
<span id="874">874</span>
<span id="875">875</span>
<span id="876">876</span>
<span id="877">877</span>
<span id="878">878</span>
<span id="879">879</span>
<span id="880">880</span>
<span id="881">881</span>
<span id="882">882</span>
<span id="883">883</span>
<span id="884">884</span>
<span id="885">885</span>
<span id="886">886</span>
<span id="887">887</span>
<span id="888">888</span>
<span id="889">889</span>
<span id="890">890</span>
<span id="891">891</span>
<span id="892">892</span>
<span id="893">893</span>
<span id="894">894</span>
<span id="895">895</span>
<span id="896">896</span>
<span id="897">897</span>
<span id="898">898</span>
<span id="899">899</span>
<span id="900">900</span>
<span id="901">901</span>
<span id="902">902</span>
<span id="903">903</span>
<span id="904">904</span>
<span id="905">905</span>
<span id="906">906</span>
<span id="907">907</span>
<span id="908">908</span>
<span id="909">909</span>
<span id="910">910</span>
<span id="911">911</span>
<span id="912">912</span>
<span id="913">913</span>
<span id="914">914</span>
<span id="915">915</span>
<span id="916">916</span>
<span id="917">917</span>
<span id="918">918</span>
<span id="919">919</span>
<span id="920">920</span>
<span id="921">921</span>
<span id="922">922</span>
<span id="923">923</span>
<span id="924">924</span>
<span id="925">925</span>
<span id="926">926</span>
<span id="927">927</span>
<span id="928">928</span>
<span id="929">929</span>
<span id="930">930</span>
<span id="931">931</span>
<span id="932">932</span>
<span id="933">933</span>
<span id="934">934</span>
<span id="935">935</span>
<span id="936">936</span>
<span id="937">937</span>
<span id="938">938</span>
<span id="939">939</span>
<span id="940">940</span>
<span id="941">941</span>
<span id="942">942</span>
<span id="943">943</span>
<span id="944">944</span>
<span id="945">945</span>
<span id="946">946</span>
<span id="947">947</span>
<span id="948">948</span>
<span id="949">949</span>
<span id="950">950</span>
<span id="951">951</span>
<span id="952">952</span>
<span id="953">953</span>
<span id="954">954</span>
<span id="955">955</span>
<span id="956">956</span>
<span id="957">957</span>
<span id="958">958</span>
<span id="959">959</span>
<span id="960">960</span>
<span id="961">961</span>
<span id="962">962</span>
<span id="963">963</span>
<span id="964">964</span>
<span id="965">965</span>
<span id="966">966</span>
<span id="967">967</span>
<span id="968">968</span>
<span id="969">969</span>
<span id="970">970</span>
<span id="971">971</span>
<span id="972">972</span>
<span id="973">973</span>
<span id="974">974</span>
<span id="975">975</span>
<span id="976">976</span>
<span id="977">977</span>
<span id="978">978</span>
<span id="979">979</span>
<span id="980">980</span>
<span id="981">981</span>
<span id="982">982</span>
<span id="983">983</span>
<span id="984">984</span>
<span id="985">985</span>
<span id="986">986</span>
<span id="987">987</span>
<span id="988">988</span>
<span id="989">989</span>
<span id="990">990</span>
<span id="991">991</span>
<span id="992">992</span>
<span id="993">993</span>
<span id="994">994</span>
<span id="995">995</span>
<span id="996">996</span>
<span id="997">997</span>
<span id="998">998</span>
<span id="999">999</span>
<span id="1000">1000</span>
<span id="1001">1001</span>
<span id="1002">1002</span>
<span id="1003">1003</span>
<span id="1004">1004</span>
<span id="1005">1005</span>
<span id="1006">1006</span>
<span id="1007">1007</span>
<span id="1008">1008</span>
<span id="1009">1009</span>
<span id="1010">1010</span>
<span id="1011">1011</span>
<span id="1012">1012</span>
<span id="1013">1013</span>
<span id="1014">1014</span>
<span id="1015">1015</span>
<span id="1016">1016</span>
<span id="1017">1017</span>
<span id="1018">1018</span>
<span id="1019">1019</span>
<span id="1020">1020</span>
<span id="1021">1021</span>
<span id="1022">1022</span>
<span id="1023">1023</span>
<span id="1024">1024</span>
<span id="1025">1025</span>
<span id="1026">1026</span>
<span id="1027">1027</span>
<span id="1028">1028</span>
<span id="1029">1029</span>
<span id="1030">1030</span>
<span id="1031">1031</span>
<span id="1032">1032</span>
<span id="1033">1033</span>
<span id="1034">1034</span>
<span id="1035">1035</span>
<span id="1036">1036</span>
<span id="1037">1037</span>
<span id="1038">1038</span>
<span id="1039">1039</span>
<span id="1040">1040</span>
<span id="1041">1041</span>
<span id="1042">1042</span>
<span id="1043">1043</span>
<span id="1044">1044</span>
<span id="1045">1045</span>
<span id="1046">1046</span>
<span id="1047">1047</span>
<span id="1048">1048</span>
<span id="1049">1049</span>
<span id="1050">1050</span>
<span id="1051">1051</span>
<span id="1052">1052</span>
<span id="1053">1053</span>
<span id="1054">1054</span>
<span id="1055">1055</span>
<span id="1056">1056</span>
<span id="1057">1057</span>
<span id="1058">1058</span>
<span id="1059">1059</span>
<span id="1060">1060</span>
<span id="1061">1061</span>
<span id="1062">1062</span>
<span id="1063">1063</span>
<span id="1064">1064</span>
<span id="1065">1065</span>
<span id="1066">1066</span>
<span id="1067">1067</span>
<span id="1068">1068</span>
<span id="1069">1069</span>
<span id="1070">1070</span>
<span id="1071">1071</span>
<span id="1072">1072</span>
<span id="1073">1073</span>
<span id="1074">1074</span>
<span id="1075">1075</span>
<span id="1076">1076</span>
<span id="1077">1077</span>
<span id="1078">1078</span>
<span id="1079">1079</span>
<span id="1080">1080</span>
<span id="1081">1081</span>
<span id="1082">1082</span>
<span id="1083">1083</span>
<span id="1084">1084</span>
<span id="1085">1085</span>
<span id="1086">1086</span>
<span id="1087">1087</span>
<span id="1088">1088</span>
<span id="1089">1089</span>
<span id="1090">1090</span>
<span id="1091">1091</span>
<span id="1092">1092</span>
<span id="1093">1093</span>
<span id="1094">1094</span>
<span id="1095">1095</span>
<span id="1096">1096</span>
<span id="1097">1097</span>
<span id="1098">1098</span>
<span id="1099">1099</span>
<span id="1100">1100</span>
<span id="1101">1101</span>
<span id="1102">1102</span>
<span id="1103">1103</span>
<span id="1104">1104</span>
<span id="1105">1105</span>
<span id="1106">1106</span>
<span id="1107">1107</span>
<span id="1108">1108</span>
<span id="1109">1109</span>
<span id="1110">1110</span>
<span id="1111">1111</span>
<span id="1112">1112</span>
<span id="1113">1113</span>
<span id="1114">1114</span>
<span id="1115">1115</span>
<span id="1116">1116</span>
<span id="1117">1117</span>
<span id="1118">1118</span>
<span id="1119">1119</span>
<span id="1120">1120</span>
<span id="1121">1121</span>
<span id="1122">1122</span>
<span id="1123">1123</span>
<span id="1124">1124</span>
<span id="1125">1125</span>
<span id="1126">1126</span>
<span id="1127">1127</span>
<span id="1128">1128</span>
<span id="1129">1129</span>
<span id="1130">1130</span>
<span id="1131">1131</span>
<span id="1132">1132</span>
<span id="1133">1133</span>
<span id="1134">1134</span>
<span id="1135">1135</span>
<span id="1136">1136</span>
<span id="1137">1137</span>
<span id="1138">1138</span>
<span id="1139">1139</span>
<span id="1140">1140</span>
<span id="1141">1141</span>
<span id="1142">1142</span>
<span id="1143">1143</span>
<span id="1144">1144</span>
<span id="1145">1145</span>
<span id="1146">1146</span>
<span id="1147">1147</span>
<span id="1148">1148</span>
<span id="1149">1149</span>
<span id="1150">1150</span>
<span id="1151">1151</span>
<span id="1152">1152</span>
<span id="1153">1153</span>
<span id="1154">1154</span>
<span id="1155">1155</span>
<span id="1156">1156</span>
<span id="1157">1157</span>
<span id="1158">1158</span>
<span id="1159">1159</span>
<span id="1160">1160</span>
<span id="1161">1161</span>
<span id="1162">1162</span>
<span id="1163">1163</span>
<span id="1164">1164</span>
<span id="1165">1165</span>
<span id="1166">1166</span>
<span id="1167">1167</span>
<span id="1168">1168</span>
<span id="1169">1169</span>
<span id="1170">1170</span>
<span id="1171">1171</span>
<span id="1172">1172</span>
<span id="1173">1173</span>
<span id="1174">1174</span>
<span id="1175">1175</span>
<span id="1176">1176</span>
<span id="1177">1177</span>
<span id="1178">1178</span>
<span id="1179">1179</span>
<span id="1180">1180</span>
<span id="1181">1181</span>
<span id="1182">1182</span>
<span id="1183">1183</span>
<span id="1184">1184</span>
<span id="1185">1185</span>
<span id="1186">1186</span>
<span id="1187">1187</span>
<span id="1188">1188</span>
<span id="1189">1189</span>
<span id="1190">1190</span>
<span id="1191">1191</span>
<span id="1192">1192</span>
<span id="1193">1193</span>
<span id="1194">1194</span>
<span id="1195">1195</span>
<span id="1196">1196</span>
<span id="1197">1197</span>
<span id="1198">1198</span>
<span id="1199">1199</span>
<span id="1200">1200</span>
<span id="1201">1201</span>
<span id="1202">1202</span>
<span id="1203">1203</span>
<span id="1204">1204</span>
<span id="1205">1205</span>
<span id="1206">1206</span>
<span id="1207">1207</span>
<span id="1208">1208</span>
<span id="1209">1209</span>
<span id="1210">1210</span>
<span id="1211">1211</span>
<span id="1212">1212</span>
<span id="1213">1213</span>
<span id="1214">1214</span>
<span id="1215">1215</span>
<span id="1216">1216</span>
<span id="1217">1217</span>
<span id="1218">1218</span>
<span id="1219">1219</span>
<span id="1220">1220</span>
<span id="1221">1221</span>
<span id="1222">1222</span>
<span id="1223">1223</span>
<span id="1224">1224</span>
<span id="1225">1225</span>
<span id="1226">1226</span>
<span id="1227">1227</span>
<span id="1228">1228</span>
<span id="1229">1229</span>
<span id="1230">1230</span>
<span id="1231">1231</span>
<span id="1232">1232</span>
<span id="1233">1233</span>
<span id="1234">1234</span>
<span id="1235">1235</span>
<span id="1236">1236</span>
<span id="1237">1237</span>
<span id="1238">1238</span>
<span id="1239">1239</span>
<span id="1240">1240</span>
<span id="1241">1241</span>
<span id="1242">1242</span>
<span id="1243">1243</span>
<span id="1244">1244</span>
</pre><pre class="rust"><code><span class="comment">/*
 * Copyright © 2022 Neil M. Sheldon
 * 
 * This Source Code Form is subject to the terms of the Mozilla Public
 * License, v. 2.0. If a copy of the MPL was not distributed with this
 * file, You can obtain one at https://mozilla.org/MPL/2.0/.
 */</span>

<span class="doccomment">/*!

In Monstorr, interpolation is the process of substituting variables and expressions with actual values at the last minute. There are actually two types of interpolation that happen in Monstorr, one occurs during the generation of stat blocks from feature descriptions and other strings, the other occurs when including an external creature file into another (see [`crate::creature_commands::CreatureCommand::Include`]). They both work basically the same, but have slightly different inputs and outputs.

Strings which can be interpolated contain normal text interspersed with interpolation expressions delimited from the rest. In order to make it easier to include feature interpolation strings inside an included document, the delimiters for feature interpolation and inclusion interpolation are different.

The result of an interpolation differs between the two modes. For inclusion, the result is a plain string that will then be deserialized into creature commands. For descriptions, however, the result is structured text.

# Expression Delimiters

When embedding interpolation in the included file, delimit expressions with &#39;$&lt;...&gt;&#39;. When embedding interpolation in features, delimit the expressions with &#39;${...}&#39;. 

All text outside these delimiters are treated as normal text. While you can use the backslash (&#39;\&#39;) to escape the dollar sign character (&#39;$&#39;), and other backslashes, this is not necessary unless, for some reason, you need to include the &#39;${&#39; character combination in regular text, or worse, the &#39;\\${&#39; character combination. In the former case you can produce that with &#39;\\\\${&#39;. In the latter, you can produce it with &#39;\\\\\\${&#39;. Outside of those instances, a dollar sign and a backslash are treated as normal characters. In interpolating for inclusion, the same applies to &#39;$&lt;&#39; and &#39;\$&lt;&#39; character combinations.

# Expression Syntax

The expression syntax is fairly simple. The following values operations are supported:

*Variable References.* A plain identifier is a variable reference. Variables are provided by Monstorr according to the mode of interpolation. In inclusion, they are string values provided as arguments by the `Include` command, see [`crate::creature_commands::CreatureCommand::Include`]. In descriptions, the variables are properties of the creature, which may be strings, numbers or dice. For available creature properties, see [`crate::creature::Creature`]. If the variable does not exist, or returns no value, an error will occur when it is referenced. 

*Strings*. Strings are delimited by double-quotes. They return a string value.

*Numbers*. Only integers are supported, and consist of a series of decimal digits. They return a number value.

*Dice.* Dice literals are supported in forms like &quot;1d8&quot; and &quot;2d6&quot;. Both numbers are required. They return a dice expression value. When a dice expression is converted to a string, it is formatted as in standard descriptions with the average followed by the actual expression in parentheses.

*Parenthesis.* Expressions in between parentheses &#39;(..)&#39; will be calculated first.

*Properties and Index.* Some values returned by variables are objects that have properties, or lists that have indexes. Properties are accessed by using the &#39;.&#39; operator followed by the property&#39;s identifier. List items are accessed by using dot operator followed by a number indicating the index to access. 

*Negating Numbers.* The &#39;-&#39; can be used before a number to negate it. The value must be a number, no other value types can be negated. Remember that if you negate a value that occurs after another expression, it may be confused with the minus operator. Use parentheses or replace it with &#39;+ -&#39; to remove this ambiguity.

*Signing Numbers and Dice.* Numbers and dice expressions can be signed, so that when they are formatted as strings, a &#39;+&#39; appears before them if they are positive. The &#39;-&#39; will always appear if they are negative. The &#39;+&#39; operator which appears before the value will ensure that that takes place. It is infectious, so if you add other values to the expression, the final result of the expression will be formatted that way. Remember that if you sign a value that occurs after another expression, it may be confused with the plus operator. Use parentheses or replace it with &#39;+ +&#39; to remove this ambiguity.

*Stringifying Values.* Numbers and dice are automatically converted to strings when they are the final result of an expression. However, for type-safety, they are not if they are used in a more compound expression, and concatenating strings and non-strings is not allowed. This prevents you from making mistakes like &#39;&quot;foo&quot; + 1 + 2&#39; when what you really meant was &#39;&quot;foo&quot; (+1 + 2)&#39;. The &#39;$&#39; operator can be used before a number or dice value to convert it to a string, making concatenation possible.

*Multiplication.* To multiply two number expressions, use the &#39;*&#39; operator. You can multiply dice by numbers to get a new dice expression. If the number is not 1 or -1, then your dice expression will be formatted with a factor. You can not multiply two dice values together, as the result is undetermined. Remember, the coefficient of a dice value is not the same as a numeric factor: &quot;2d6&quot; is not the same as &quot;1d6 x 2&quot;, as they have different sets of possible results.

*Division.* As only integer number values are allowed, it is necessary to know how to deal with fractions when dividing them. For that reason, there are two division operators. Use &quot;/&lt;&quot; to divide the numbers and round the result down, use &quot;/&gt;&quot; to divide the numbers and round the result up. Dice values can be divided by numbers, which will result in them having a factor expression when formatted. However, nothing can be divided by dice expressions, as the result of that is undetermined.

*Addition, Subtraction and Concatenation.* To add and subtract number and dice values, use the &quot;+&quot; and &quot;-&quot; characters respectively. Adding dice together can create more complex dice expressions which involve several dice terms. If you add the same dice together, it should result in simply changing the coefficient. For example, &quot;2d6 + 1d6&quot; should result in &quot;3d6&quot;. However, &quot;2d4 - 1d4&quot; would not be the same as &quot;1d4&quot;, as they would have different sets of results (the first would have values ranging from -1 to 7, while the other has values ranging from 1-4, and that doesn&#39;t even consider distribution )

*Consecutive Expressions.* If two expressions are included consecutive to each other, then the results are both pushed out to the resulting string in order. For example, &#39;&quot;foo&quot; &quot;bar&quot;&#39; would output the text &quot;foobar&quot;.

*Structured Text Functions.* The result of interpolating a description is not just a simple string, it&#39;s a list of text blocks that can contain styled text. The actual result is a list of [`crate::structured_text::TextBlock`]s. There are two kinds of text blocks, and each of these can contain lists of four different kinds of spans. These are achieved through special functions.

A structured text function consists of a keyword, followed by an optional parentheses expression. Unlike normal expressions, these parentheses can contain normal template text, thus &quot;italic( } italicized text ${ )&quot; can be done. There are four such functions, which modify the structured text output.

* `par`: starts a new normal paragraph block, allowing you to break up your description text. There is a variant of this function which takes an argument in parentheses, but it should not be used, as it has the result of creating what looks like a new feature in the stat block.

* `sub(...)`, `sub`: starts a subparagraph, with a heading contained in the parenthesis. In official content, a subparagraph in this case would create a paragraph with a hanging indent. The heading is an optional emphasized text that will appear at the beginning of the first line. In the official content, subparagraphs are used in the metallic dragon breath weapons, and in spellcasting spell lists.

* &#39;italic(...)&#39;: sets the text enclosed in the parentheses as italic. Nesting italic text inside italic text is not allowed, as it has undetermined effects. You can nest bold text inside italics, however.

* &#39;bold(...)&#39;: sets the text enclosed in the parentheses as bold. Nesting bold text inside bold text is not allowed, as it has undetermined effects. You can nest italic text inside bold, however.

# Examples

For examples of interpolation, look at the built-in creatures, whose raw files can be retrieved using the validate command from the Monstorr command line.

*/</span>
<span class="kw">use</span> <span class="ident">std::iter::Peekable</span>;
<span class="kw">use</span> <span class="ident">std::rc::Rc</span>;
<span class="kw">use</span> <span class="ident">std::collections::HashMap</span>;

<span class="kw">use</span> <span class="ident"><span class="kw">crate</span>::dice::Dice</span>;
<span class="kw">use</span> <span class="ident"><span class="kw">crate</span>::dice_expression::DiceExpression</span>;
<span class="kw">use</span> <span class="ident"><span class="kw">crate</span>::tokenizer::Token</span>;
<span class="kw">use</span> <span class="ident"><span class="kw">crate</span>::parse_position::Position</span>;
<span class="kw">use</span> <span class="ident"><span class="kw">crate</span>::parse_position::PositionRange</span>;
<span class="kw">use</span> <span class="ident"><span class="kw">crate</span>::errors::TokenError</span>;
<span class="kw">use</span> <span class="ident"><span class="kw">crate</span>::errors::TokenErrorDetails</span>;
<span class="kw">use</span> <span class="ident"><span class="kw">crate</span>::errors::InterpolationError</span>;
<span class="kw">use</span> <span class="ident"><span class="kw">crate</span>::errors::InterpolationErrorDetails</span>;
<span class="kw">use</span> <span class="ident"><span class="kw">crate</span>::tokenizer::Tokenizer</span>;
<span class="kw">use</span> <span class="ident"><span class="kw">crate</span>::utils::NextOk</span>;
<span class="kw">use</span> <span class="ident"><span class="kw">crate</span>::ident_start</span>;
<span class="kw">use</span> <span class="ident"><span class="kw">crate</span>::digit</span>;
<span class="kw">use</span> <span class="ident"><span class="kw">crate</span>::utils::FloorDiv</span>;
<span class="kw">use</span> <span class="ident"><span class="kw">crate</span>::utils::CeilingDiv</span>;
<span class="kw">use</span> <span class="ident"><span class="kw">crate</span>::structured_text::TextBlock</span>;
<span class="kw">use</span> <span class="ident"><span class="kw">crate</span>::structured_text::TextSpan</span>;

<span class="attribute">#[<span class="ident">derive</span>(<span class="ident">Clone</span>,<span class="ident">Debug</span>)]</span>
<span class="kw">pub</span> <span class="kw">enum</span> <span class="ident">StructureKeyword</span> {
    <span class="ident">Par</span>,
    <span class="ident">Sub</span>,
    <span class="ident">Italic</span>,
    <span class="ident">Bold</span>
}

<span class="kw">enum</span> <span class="ident">InterpolationState</span> {
    <span class="ident">Initial</span>,
    <span class="ident">Continuing</span>
}

<span class="kw">enum</span> <span class="ident">InterpolationMode</span> {
    <span class="ident">DeserializeCreatureCommands</span>,
    <span class="ident">CalculateStatBlock</span>
}

<span class="kw">struct</span> <span class="ident">InterpolationTokenizer</span><span class="op">&lt;</span><span class="ident">Source</span>: <span class="ident">Iterator</span><span class="op">&lt;</span><span class="ident">Item</span><span class="op">=</span><span class="ident">char</span><span class="op">&gt;</span><span class="op">&gt;</span> {
    <span class="ident">source_name</span>: <span class="ident">String</span>,
    <span class="ident">source</span>: <span class="ident">Peekable</span><span class="op">&lt;</span><span class="ident">Source</span><span class="op">&gt;</span>,
    <span class="ident">mode</span>: <span class="ident">InterpolationMode</span>,
    <span class="ident">state</span>: <span class="ident">InterpolationState</span>,
    <span class="ident">position</span>: <span class="ident">PositionRange</span>,
    <span class="ident">current</span>: <span class="prelude-ty">Option</span><span class="op">&lt;</span><span class="prelude-ty">Result</span><span class="op">&lt;</span>(<span class="ident">Token</span><span class="op">&lt;</span><span class="ident">StructureKeyword</span><span class="op">&gt;</span>,<span class="ident">PositionRange</span>),<span class="ident">TokenErrorDetails</span><span class="op">&gt;</span><span class="op">&gt;</span>
}

<span class="kw">impl</span><span class="op">&lt;</span><span class="ident">Source</span>: <span class="ident">Iterator</span><span class="op">&lt;</span><span class="ident">Item</span><span class="op">=</span><span class="ident">char</span><span class="op">&gt;</span><span class="op">&gt;</span> <span class="ident">Tokenizer</span><span class="op">&lt;</span><span class="ident">StructureKeyword</span><span class="op">&gt;</span> <span class="kw">for</span> <span class="ident">InterpolationTokenizer</span><span class="op">&lt;</span><span class="ident">Source</span><span class="op">&gt;</span> {

    <span class="kw">fn</span> <span class="ident">resolve_keyword</span>(<span class="kw-2">&amp;</span><span class="self">self</span>, <span class="ident">identifier</span>: <span class="kw-2">&amp;</span><span class="ident">str</span>) -&gt; <span class="prelude-ty">Option</span><span class="op">&lt;</span><span class="ident">StructureKeyword</span><span class="op">&gt;</span> {
        <span class="kw">if</span> <span class="kw">let</span> <span class="ident">InterpolationMode::CalculateStatBlock</span> <span class="op">=</span> <span class="self">self</span>.<span class="ident">mode</span> {
            <span class="kw">match</span> <span class="ident">identifier</span> {
                <span class="string">&quot;par&quot;</span> =&gt; <span class="prelude-val">Some</span>(<span class="ident">StructureKeyword::Par</span>),
                <span class="string">&quot;sub&quot;</span> =&gt; <span class="prelude-val">Some</span>(<span class="ident">StructureKeyword::Sub</span>),
                <span class="string">&quot;italic&quot;</span> =&gt; <span class="prelude-val">Some</span>(<span class="ident">StructureKeyword::Italic</span>),
                <span class="string">&quot;bold&quot;</span> =&gt; <span class="prelude-val">Some</span>(<span class="ident">StructureKeyword::Bold</span>),
                <span class="kw">_</span> =&gt; <span class="prelude-val">None</span>
            }
        } <span class="kw">else</span> {
            <span class="prelude-val">None</span>
        }

    }



    <span class="kw">fn</span> <span class="ident">next_char</span>(<span class="kw-2">&amp;mut</span> <span class="self">self</span>) -&gt; <span class="prelude-ty">Option</span><span class="op">&lt;</span><span class="ident">char</span><span class="op">&gt;</span> {
        <span class="kw">match</span> <span class="self">self</span>.<span class="ident">source</span>.<span class="ident">next</span>() {
            <span class="prelude-val">Some</span>(<span class="ident">char</span>) =&gt; {
                <span class="kw">match</span> <span class="ident">char</span> {
                    <span class="string">&#39;\n&#39;</span> =&gt; {
                        <span class="self">self</span>.<span class="ident">position</span>.<span class="ident">end</span>.<span class="ident">line</span> <span class="op">+</span><span class="op">=</span> <span class="number">1</span>;
                        <span class="self">self</span>.<span class="ident">position</span>.<span class="ident">end</span>.<span class="ident">column</span> <span class="op">=</span> <span class="number">0</span>;    
                    },
                    <span class="string">&#39;\r&#39;</span> =&gt; (
                        <span class="comment">// this is probably part of a CRLF pair on windows. We don&#39;t want to increment characters that will mess up positioning,</span>
                        <span class="comment">// and we don&#39;t want to increment the line because the \n is going to do it. \r is only supported as a line-break</span>
                        <span class="comment">// in things like Commodore and Apple II, which are far from being supported here.</span>
                    ), 
                    <span class="kw">_</span> =&gt; <span class="self">self</span>.<span class="ident">position</span>.<span class="ident">end</span>.<span class="ident">column</span> <span class="op">+</span><span class="op">=</span> <span class="number">1</span>
                }
                <span class="prelude-val">Some</span>(<span class="ident">char</span>)
            },
            <span class="prelude-val">None</span> =&gt; <span class="prelude-val">None</span>
        }
    }

    <span class="kw">fn</span> <span class="ident">peek_char</span>(<span class="kw-2">&amp;mut</span> <span class="self">self</span>) -&gt; <span class="prelude-ty">Option</span><span class="op">&lt;</span><span class="kw-2">&amp;</span><span class="ident">char</span><span class="op">&gt;</span> {
        <span class="self">self</span>.<span class="ident">source</span>.<span class="ident">peek</span>()
    }

} 

<span class="kw">impl</span><span class="op">&lt;</span><span class="ident">Source</span>: <span class="ident">Iterator</span><span class="op">&lt;</span><span class="ident">Item</span><span class="op">=</span><span class="ident">char</span><span class="op">&gt;</span><span class="op">&gt;</span> <span class="ident">InterpolationTokenizer</span><span class="op">&lt;</span><span class="ident">Source</span><span class="op">&gt;</span> {

    <span class="kw">pub</span> <span class="kw">fn</span> <span class="ident">new</span>(<span class="ident">source_name</span>: <span class="kw-2">&amp;</span><span class="ident">str</span>, <span class="ident">source</span>: <span class="ident">Source</span>, <span class="ident">mode</span>: <span class="ident">InterpolationMode</span>) -&gt; <span class="self">Self</span> {
        <span class="self">Self</span> {
            <span class="ident">source_name</span>: <span class="ident">source_name</span>.<span class="ident">to_owned</span>(),
            <span class="ident">source</span>: <span class="ident">source</span>.<span class="ident">peekable</span>(),
            <span class="ident">mode</span>,
            <span class="ident">state</span>: <span class="ident">InterpolationState::Initial</span>,
            <span class="ident">position</span>: <span class="ident">PositionRange</span> {
                <span class="ident">start</span>: <span class="ident">Position</span> {
                    <span class="ident">line</span>: <span class="number">1</span>,
                    <span class="ident">column</span>: <span class="number">1</span>
                },
                <span class="ident">end</span>: <span class="ident">Position</span> {
                    <span class="ident">line</span>: <span class="number">1</span>,
                    <span class="ident">column</span>: <span class="number">1</span>
                }
            },
            <span class="ident">current</span>: <span class="prelude-val">None</span>
        }
    }

    <span class="kw">fn</span> <span class="ident">start_token</span>(<span class="kw-2">&amp;mut</span> <span class="self">self</span>) {
        <span class="self">self</span>.<span class="ident">position</span>.<span class="ident">start</span> <span class="op">=</span> <span class="self">self</span>.<span class="ident">position</span>.<span class="ident">end</span>.<span class="ident">clone</span>()
    }

    <span class="kw">fn</span> <span class="ident">stop_token</span>(<span class="kw-2">&amp;mut</span> <span class="self">self</span>, <span class="ident">token</span>: <span class="prelude-ty">Result</span><span class="op">&lt;</span><span class="ident">Token</span><span class="op">&lt;</span><span class="ident">StructureKeyword</span><span class="op">&gt;</span>,<span class="ident">TokenError</span><span class="op">&gt;</span>) -&gt; <span class="prelude-ty">Option</span><span class="op">&lt;</span><span class="prelude-ty">Result</span><span class="op">&lt;</span>(<span class="ident">Token</span><span class="op">&lt;</span><span class="ident">StructureKeyword</span><span class="op">&gt;</span>,<span class="ident">PositionRange</span>),<span class="ident">TokenErrorDetails</span><span class="op">&gt;</span><span class="op">&gt;</span> {
        <span class="self">self</span>.<span class="ident">current</span> <span class="op">=</span> <span class="prelude-val">Some</span>(<span class="kw">match</span> <span class="ident">token</span>.<span class="ident">clone</span>() {
            <span class="prelude-val">Ok</span>(<span class="ident">token</span>) =&gt; <span class="prelude-val">Ok</span>((<span class="ident">token</span>,<span class="self">self</span>.<span class="ident">position</span>.<span class="ident">clone</span>())),
            <span class="prelude-val">Err</span>(<span class="ident">token</span>) =&gt; <span class="prelude-val">Err</span>(<span class="ident">TokenErrorDetails</span> {
                <span class="ident">error</span>: <span class="ident">token</span>,
                <span class="ident">source_name</span>: <span class="self">self</span>.<span class="ident">source_name</span>.<span class="ident">clone</span>(),
                <span class="ident">position</span>: <span class="self">self</span>.<span class="ident">position</span>.<span class="ident">clone</span>()
            })
        });
        <span class="self">self</span>.<span class="ident">current</span>.<span class="ident">clone</span>()
    }

    <span class="kw">fn</span> <span class="ident">no_more_tokens</span>(<span class="kw-2">&amp;mut</span> <span class="self">self</span>) -&gt; <span class="prelude-ty">Option</span><span class="op">&lt;</span><span class="prelude-ty">Result</span><span class="op">&lt;</span>(<span class="ident">Token</span><span class="op">&lt;</span><span class="ident">StructureKeyword</span><span class="op">&gt;</span>,<span class="ident">PositionRange</span>),<span class="ident">TokenErrorDetails</span><span class="op">&gt;</span><span class="op">&gt;</span> {
        <span class="self">self</span>.<span class="ident">current</span> <span class="op">=</span> <span class="prelude-val">None</span>;
        <span class="prelude-val">None</span>
    }


}

<span class="kw">impl</span><span class="op">&lt;</span><span class="ident">Source</span>: <span class="ident">Iterator</span><span class="op">&lt;</span><span class="ident">Item</span><span class="op">=</span><span class="ident">char</span><span class="op">&gt;</span><span class="op">&gt;</span> <span class="ident">Iterator</span> <span class="kw">for</span> <span class="ident">InterpolationTokenizer</span><span class="op">&lt;</span><span class="ident">Source</span><span class="op">&gt;</span> {

    <span class="kw">type</span> <span class="ident">Item</span> <span class="op">=</span> <span class="prelude-ty">Result</span><span class="op">&lt;</span>(<span class="ident">Token</span><span class="op">&lt;</span><span class="ident">StructureKeyword</span><span class="op">&gt;</span>,<span class="ident">PositionRange</span>),<span class="ident">TokenErrorDetails</span><span class="op">&gt;</span>;

    <span class="kw">fn</span> <span class="ident">next</span>(<span class="kw-2">&amp;mut</span> <span class="self">self</span>) -&gt; <span class="prelude-ty">Option</span><span class="op">&lt;</span><span class="ident"><span class="self">Self</span>::Item</span><span class="op">&gt;</span> {

        <span class="kw">match</span> <span class="self">self</span>.<span class="ident">state</span> {
            <span class="ident">InterpolationState::Initial</span> =&gt; {
                <span class="comment">// automatically switch to the continuing mode. A file always consists of at least one text token,</span>
                <span class="comment">// even if it&#39;s 0-length.</span>
                <span class="self">self</span>.<span class="ident">state</span> <span class="op">=</span> <span class="ident">InterpolationState::Continuing</span>;

                <span class="self">self</span>.<span class="ident">start_token</span>();

                <span class="kw">let</span> <span class="ident">mode_char</span> <span class="op">=</span> <span class="kw">match</span> <span class="self">self</span>.<span class="ident">mode</span> {
                    <span class="ident">InterpolationMode::DeserializeCreatureCommands</span> =&gt; <span class="string">&#39;&lt;&#39;</span>,
                    <span class="ident">InterpolationMode::CalculateStatBlock</span> =&gt; <span class="string">&#39;{&#39;</span>
                };
                <span class="kw">let</span> <span class="ident">text</span> <span class="op">=</span> <span class="self">self</span>.<span class="ident">template_text</span>(<span class="kw-2">&amp;</span><span class="ident">mode_char</span>);
                <span class="self">self</span>.<span class="ident">stop_token</span>(<span class="ident">text</span>)
            },
            <span class="ident">InterpolationState::Continuing</span> =&gt; {
                <span class="self">self</span>.<span class="ident">skip_whitespace</span>();

                <span class="self">self</span>.<span class="ident">start_token</span>();
                <span class="kw">match</span> <span class="self">self</span>.<span class="ident">next_char</span>() {
                    <span class="prelude-val">Some</span>(<span class="ident">char</span>) <span class="kw">if</span> <span class="macro">matches!</span>(<span class="ident">char</span>,<span class="macro">ident_start!</span>()) =&gt; {
                        <span class="kw">let</span> <span class="ident">identifier</span> <span class="op">=</span> <span class="self">self</span>.<span class="ident">identifier</span>(<span class="ident">char</span>);
                        <span class="self">self</span>.<span class="ident">stop_token</span>(<span class="ident">identifier</span>)
                    },
                    <span class="prelude-val">Some</span>(<span class="ident">char</span>) <span class="kw">if</span> <span class="macro">matches!</span>(<span class="ident">char</span>,<span class="macro">digit!</span>()) =&gt; {
                        <span class="kw">let</span> <span class="ident">result</span> <span class="op">=</span> <span class="self">self</span>.<span class="ident">number_or_dice</span>(<span class="ident">char</span>);
                        <span class="self">self</span>.<span class="ident">stop_token</span>(<span class="ident">result</span>)
                    },
                    <span class="prelude-val">Some</span>(<span class="string">&#39;&quot;&#39;</span>) =&gt; {
                        <span class="kw">let</span> <span class="ident">string</span> <span class="op">=</span> <span class="self">self</span>.<span class="ident">string</span>();
                        <span class="self">self</span>.<span class="ident">stop_token</span>(<span class="ident">string</span>)
                    },
                    <span class="prelude-val">Some</span>(<span class="string">&#39;+&#39;</span>) =&gt; <span class="self">self</span>.<span class="ident">stop_token</span>(<span class="prelude-val">Ok</span>(<span class="ident">Token::Plus</span>)),
                    <span class="prelude-val">Some</span>(<span class="string">&#39;-&#39;</span>) =&gt; <span class="self">self</span>.<span class="ident">stop_token</span>(<span class="prelude-val">Ok</span>(<span class="ident">Token::Minus</span>)),
                    <span class="prelude-val">Some</span>(<span class="string">&#39;*&#39;</span>) =&gt; <span class="self">self</span>.<span class="ident">stop_token</span>(<span class="prelude-val">Ok</span>(<span class="ident">Token::Asterisk</span>)),
                    <span class="prelude-val">Some</span>(<span class="string">&#39;/&#39;</span>) =&gt; <span class="kw">match</span> <span class="self">self</span>.<span class="ident">peek_char</span>() {
                        <span class="prelude-val">Some</span>(<span class="string">&#39;&lt;&#39;</span>) =&gt; {
                            <span class="self">self</span>.<span class="ident">next_char</span>();
                            <span class="self">self</span>.<span class="ident">stop_token</span>(<span class="prelude-val">Ok</span>(<span class="ident">Token::SlashLessThan</span>))
                        },
                        <span class="prelude-val">Some</span>(<span class="string">&#39;&gt;&#39;</span>) =&gt; {
                            <span class="self">self</span>.<span class="ident">next_char</span>();
                            <span class="self">self</span>.<span class="ident">stop_token</span>(<span class="prelude-val">Ok</span>(<span class="ident">Token::SlashGreaterThan</span>))
                        },
                        <span class="kw">_</span> =&gt; {
                            <span class="self">self</span>.<span class="ident">stop_token</span>(<span class="prelude-val">Err</span>(<span class="ident">TokenError::SlashIsNotValid</span>))
                        }
                    },
                    <span class="prelude-val">Some</span>(<span class="string">&#39;(&#39;</span>) =&gt; <span class="self">self</span>.<span class="ident">stop_token</span>(<span class="prelude-val">Ok</span>(<span class="ident">Token::OpenParenthesis</span>)),
                    <span class="prelude-val">Some</span>(<span class="string">&#39;)&#39;</span>) =&gt; <span class="self">self</span>.<span class="ident">stop_token</span>(<span class="prelude-val">Ok</span>(<span class="ident">Token::CloseParenthesis</span>)),
                    <span class="prelude-val">Some</span>(<span class="string">&#39;.&#39;</span>) =&gt; <span class="self">self</span>.<span class="ident">stop_token</span>(<span class="prelude-val">Ok</span>(<span class="ident">Token::Dot</span>)),
                    <span class="prelude-val">Some</span>(<span class="string">&#39;$&#39;</span>) =&gt; <span class="self">self</span>.<span class="ident">stop_token</span>(<span class="prelude-val">Ok</span>(<span class="ident">Token::Dollar</span>)),
                    <span class="prelude-val">Some</span>(<span class="string">&#39;&gt;&#39;</span>) <span class="kw">if</span> <span class="macro">matches!</span>(<span class="self">self</span>.<span class="ident">mode</span>,<span class="ident">InterpolationMode::DeserializeCreatureCommands</span>) =&gt; {
                        <span class="kw">let</span> <span class="ident">text</span> <span class="op">=</span> <span class="self">self</span>.<span class="ident">template_text</span>(<span class="kw-2">&amp;</span><span class="string">&#39;&lt;&#39;</span>);
                        <span class="self">self</span>.<span class="ident">stop_token</span>(<span class="ident">text</span>)
                    },
                    <span class="prelude-val">Some</span>(<span class="string">&#39;}&#39;</span>) <span class="kw">if</span> <span class="macro">matches!</span>(<span class="self">self</span>.<span class="ident">mode</span>,<span class="ident">InterpolationMode::CalculateStatBlock</span>) =&gt; {
                        <span class="kw">let</span> <span class="ident">text</span> <span class="op">=</span> <span class="self">self</span>.<span class="ident">template_text</span>(<span class="kw-2">&amp;</span><span class="string">&#39;{&#39;</span>);
                        <span class="self">self</span>.<span class="ident">stop_token</span>(<span class="ident">text</span>)
                    },
                    <span class="prelude-val">Some</span>(<span class="kw">_</span>) =&gt; <span class="self">self</span>.<span class="ident">stop_token</span>(<span class="prelude-val">Err</span>(<span class="ident">TokenError::UnexpectedCharacter</span>)),
                    <span class="prelude-val">None</span> =&gt; <span class="self">self</span>.<span class="ident">no_more_tokens</span>()
                }
            }
        }
        

    }

}



<span class="kw">pub</span> <span class="kw">trait</span> <span class="ident">InterpolationObject</span> {

    <span class="kw">fn</span> <span class="ident">get_property</span>(<span class="kw-2">&amp;</span><span class="self">self</span>, <span class="ident">property</span>: <span class="kw-2">&amp;</span><span class="ident">Rc</span><span class="op">&lt;</span><span class="ident">str</span><span class="op">&gt;</span>) -&gt; <span class="prelude-ty">Option</span><span class="op">&lt;</span><span class="ident">InterpolationValue</span><span class="op">&gt;</span>;

    <span class="comment">// this only needs to be implemented by an array object</span>
    <span class="kw">fn</span> <span class="ident">get_index</span>(<span class="kw-2">&amp;</span><span class="self">self</span>, <span class="ident">_index</span>: <span class="kw-2">&amp;</span><span class="ident">usize</span>) -&gt; <span class="prelude-ty">Option</span><span class="op">&lt;</span><span class="ident">InterpolationValue</span><span class="op">&gt;</span> {
        <span class="prelude-val">None</span>
    }
}

<span class="kw">impl</span> <span class="ident">InterpolationObject</span> <span class="kw">for</span> () {

    <span class="kw">fn</span> <span class="ident">get_property</span>(<span class="kw-2">&amp;</span><span class="self">self</span>, <span class="ident">_property</span>: <span class="kw-2">&amp;</span><span class="ident">Rc</span><span class="op">&lt;</span><span class="ident">str</span><span class="op">&gt;</span>) -&gt; <span class="prelude-ty">Option</span><span class="op">&lt;</span><span class="ident">InterpolationValue</span><span class="op">&gt;</span> {
        <span class="prelude-val">None</span>
    }

}

<span class="comment">// TODO: Get rid of this.</span>
<span class="kw">pub</span> <span class="kw">struct</span> <span class="ident">OverriddenInterpolationObject</span> {
    <span class="ident">overridden_namespace</span>: <span class="ident">Rc</span><span class="op">&lt;</span><span class="ident">str</span><span class="op">&gt;</span>,
    <span class="ident">overridden</span>: <span class="ident">Rc</span><span class="op">&lt;</span><span class="kw">dyn</span> <span class="ident">InterpolationObject</span><span class="op">&gt;</span>,
    <span class="ident">overrider</span>: <span class="ident">Rc</span><span class="op">&lt;</span><span class="kw">dyn</span> <span class="ident">InterpolationObject</span><span class="op">&gt;</span>
}

<span class="kw">impl</span> <span class="ident">InterpolationObject</span> <span class="kw">for</span> <span class="ident">OverriddenInterpolationObject</span> {

    <span class="kw">fn</span> <span class="ident">get_property</span>(<span class="kw-2">&amp;</span><span class="self">self</span>, <span class="ident">property</span>: <span class="kw-2">&amp;</span><span class="ident">Rc</span><span class="op">&lt;</span><span class="ident">str</span><span class="op">&gt;</span>) -&gt; <span class="prelude-ty">Option</span><span class="op">&lt;</span><span class="ident">InterpolationValue</span><span class="op">&gt;</span> {
        <span class="kw">if</span> <span class="ident">property</span> <span class="op">==</span> <span class="kw-2">&amp;</span><span class="self">self</span>.<span class="ident">overridden_namespace</span> {
            <span class="self">self</span>.<span class="ident">overridden</span>.<span class="ident">get_property</span>(<span class="ident">property</span>)
        } <span class="kw">else</span> <span class="kw">if</span> <span class="kw">let</span> <span class="prelude-val">Some</span>(<span class="ident">value</span>) <span class="op">=</span> <span class="self">self</span>.<span class="ident">overrider</span>.<span class="ident">get_property</span>(<span class="ident">property</span>) {
            <span class="prelude-val">Some</span>(<span class="ident">value</span>)
        } <span class="kw">else</span> {
            <span class="self">self</span>.<span class="ident">overridden</span>.<span class="ident">get_property</span>(<span class="ident">property</span>)
        }
    }

    <span class="comment">// this only needs to be implemented by an array object</span>
    <span class="kw">fn</span> <span class="ident">get_index</span>(<span class="kw-2">&amp;</span><span class="self">self</span>, <span class="ident">index</span>: <span class="kw-2">&amp;</span><span class="ident">usize</span>) -&gt; <span class="prelude-ty">Option</span><span class="op">&lt;</span><span class="ident">InterpolationValue</span><span class="op">&gt;</span> {
        <span class="kw">if</span> <span class="kw">let</span> <span class="prelude-val">Some</span>(<span class="ident">value</span>) <span class="op">=</span> <span class="self">self</span>.<span class="ident">overrider</span>.<span class="ident">get_index</span>(<span class="ident">index</span>) {
            <span class="prelude-val">Some</span>(<span class="ident">value</span>)
        } <span class="kw">else</span> {
            <span class="self">self</span>.<span class="ident">overridden</span>.<span class="ident">get_index</span>(<span class="ident">index</span>)
        }
    }

}

<span class="kw">impl</span><span class="op">&lt;</span><span class="ident">T</span>: <span class="ident">InterpolationObject</span><span class="op">&gt;</span> <span class="ident">InterpolationObject</span> <span class="kw">for</span> <span class="ident">Rc</span><span class="op">&lt;</span><span class="ident">T</span><span class="op">&gt;</span> {
 
    <span class="kw">fn</span> <span class="ident">get_property</span>(<span class="kw-2">&amp;</span><span class="self">self</span>, <span class="ident">property</span>: <span class="kw-2">&amp;</span><span class="ident">Rc</span><span class="op">&lt;</span><span class="ident">str</span><span class="op">&gt;</span>) -&gt; <span class="prelude-ty">Option</span><span class="op">&lt;</span><span class="ident">InterpolationValue</span><span class="op">&gt;</span> {
        <span class="self">self</span>.<span class="ident">as_ref</span>().<span class="ident">get_property</span>(<span class="ident">property</span>)
    }

    <span class="kw">fn</span> <span class="ident">get_index</span>(<span class="kw-2">&amp;</span><span class="self">self</span>, <span class="ident">index</span>: <span class="kw-2">&amp;</span><span class="ident">usize</span>) -&gt; <span class="prelude-ty">Option</span><span class="op">&lt;</span><span class="ident">InterpolationValue</span><span class="op">&gt;</span> {
        <span class="self">self</span>.<span class="ident">as_ref</span>().<span class="ident">get_index</span>(<span class="ident">index</span>)
    }

}

<span class="kw">impl</span> <span class="ident">InterpolationObject</span> <span class="kw">for</span> <span class="ident">HashMap</span><span class="op">&lt;</span><span class="ident">String</span>,<span class="ident">String</span><span class="op">&gt;</span> {

    <span class="kw">fn</span> <span class="ident">get_property</span>(<span class="kw-2">&amp;</span><span class="self">self</span>, <span class="ident">property</span>: <span class="kw-2">&amp;</span><span class="ident">Rc</span><span class="op">&lt;</span><span class="ident">str</span><span class="op">&gt;</span>) -&gt; <span class="prelude-ty">Option</span><span class="op">&lt;</span><span class="ident">InterpolationValue</span><span class="op">&gt;</span> {
        <span class="kw">if</span> <span class="kw">let</span> <span class="prelude-val">Some</span>(<span class="ident">value</span>) <span class="op">=</span> <span class="self">self</span>.<span class="ident">get</span>(<span class="ident">property</span>.<span class="ident">as_ref</span>()) {
            <span class="prelude-val">Some</span>(<span class="ident">InterpolationValue::String</span>(<span class="ident">Rc::from</span>(<span class="ident">value</span>.<span class="ident">as_str</span>())))
        } <span class="kw">else</span> {
            <span class="prelude-val">None</span>
        }
    }

}


<span class="attribute">#[<span class="ident">derive</span>(<span class="ident">Clone</span>)]</span>
<span class="kw">pub</span> <span class="kw">enum</span> <span class="ident">InterpolationValue</span> {
    <span class="ident">String</span>(<span class="ident">Rc</span><span class="op">&lt;</span><span class="ident">str</span><span class="op">&gt;</span>),
    <span class="ident">Number</span>(<span class="ident">isize</span>,<span class="ident">bool</span>), <span class="comment">// value, whether to display sign in string</span>
    <span class="ident">Dice</span>(<span class="ident">DiceExpression</span>,<span class="ident">bool</span>), <span class="comment">// value, whether to display sign in string</span>
    <span class="attribute">#[<span class="ident">allow</span>(<span class="ident">dead_code</span>)]</span> <span class="comment">// FUTURE: I&#39;m leaving this because it might come in handy some day.</span>
    <span class="ident">Object</span>(<span class="ident">Rc</span><span class="op">&lt;</span><span class="kw">dyn</span> <span class="ident">InterpolationObject</span><span class="op">&gt;</span>) 
}


<span class="kw">impl</span> <span class="ident">InterpolationValue</span> {

    <span class="kw">fn</span> <span class="ident">get_property</span>(<span class="kw-2">&amp;</span><span class="self">self</span>, <span class="ident">property</span>: <span class="kw-2">&amp;</span><span class="ident">Rc</span><span class="op">&lt;</span><span class="ident">str</span><span class="op">&gt;</span>) -&gt; <span class="prelude-ty">Option</span><span class="op">&lt;</span><span class="ident">InterpolationValue</span><span class="op">&gt;</span> {
        <span class="kw">match</span> <span class="self">self</span> {
            <span class="ident">InterpolationValue::Object</span>(<span class="ident">object</span>) =&gt; <span class="ident">object</span>.<span class="ident">get_property</span>(<span class="ident">property</span>),
            <span class="kw">_</span> =&gt; <span class="prelude-val">None</span>
        }
    }

    <span class="kw">fn</span> <span class="ident">get_index</span>(<span class="kw-2">&amp;</span><span class="self">self</span>, <span class="ident">index</span>: <span class="kw-2">&amp;</span><span class="ident">usize</span>) -&gt; <span class="prelude-ty">Option</span><span class="op">&lt;</span><span class="ident">InterpolationValue</span><span class="op">&gt;</span> {
        <span class="kw">match</span> <span class="self">self</span> {
            <span class="ident">InterpolationValue::Object</span>(<span class="ident">object</span>) =&gt; <span class="ident">object</span>.<span class="ident">get_index</span>(<span class="ident">index</span>),
            <span class="kw">_</span> =&gt; <span class="prelude-val">None</span>
        }
    }

    <span class="kw">fn</span> <span class="ident">negate</span>(<span class="kw-2">&amp;</span><span class="self">self</span>) -&gt; <span class="prelude-ty">Result</span><span class="op">&lt;</span><span class="ident">InterpolationValue</span>,<span class="ident">InterpolationError</span><span class="op">&gt;</span> {
        <span class="kw">match</span> <span class="self">self</span> {
            <span class="ident">InterpolationValue::Number</span>(<span class="ident">num</span>,<span class="ident">sign</span>) =&gt; <span class="prelude-val">Ok</span>(<span class="ident">InterpolationValue::Number</span>(<span class="op">-</span><span class="ident">num</span>,<span class="kw-2">*</span><span class="ident">sign</span>)),
            <span class="ident">InterpolationValue::Dice</span>(<span class="ident">dice</span>,<span class="ident">sign</span>) =&gt; <span class="prelude-val">Ok</span>(<span class="ident">InterpolationValue::Dice</span>(<span class="ident">dice</span>.<span class="ident">multiply</span>(<span class="kw-2">&amp;</span><span class="op">-</span><span class="number">1</span>),<span class="kw-2">*</span><span class="ident">sign</span>)),
            <span class="ident">InterpolationValue::String</span>(<span class="kw">_</span>) =&gt; <span class="prelude-val">Err</span>(<span class="ident">InterpolationError::CantNegateString</span>),
            <span class="ident">InterpolationValue::Object</span>(<span class="kw">_</span>) =&gt; <span class="prelude-val">Err</span>(<span class="ident">InterpolationError::CantNegateObject</span>)
                
        }
    }

    <span class="kw">fn</span> <span class="ident">stringify</span>(<span class="kw-2">&amp;</span><span class="self">self</span>) -&gt; <span class="prelude-ty">Result</span><span class="op">&lt;</span><span class="ident">InterpolationValue</span>,<span class="ident">InterpolationError</span><span class="op">&gt;</span> {
        <span class="kw">match</span> <span class="self">self</span> {
            <span class="ident">InterpolationValue::Number</span>(<span class="kw">_</span>,<span class="kw">_</span>) <span class="op">|</span>
            <span class="ident">InterpolationValue::Dice</span>(<span class="kw">_</span>,<span class="kw">_</span>) =&gt; <span class="prelude-val">Ok</span>(<span class="ident">InterpolationValue::String</span>(<span class="ident">Rc::from</span>(<span class="macro">format!</span>(<span class="string">&quot;{}&quot;</span>,<span class="self">self</span>)))),
            <span class="ident">InterpolationValue::String</span>(<span class="kw">_</span>) =&gt; <span class="prelude-val">Err</span>(<span class="ident">InterpolationError::StringIsAlreadyStringified</span>),
            <span class="ident">InterpolationValue::Object</span>(<span class="kw">_</span>) =&gt; <span class="prelude-val">Err</span>(<span class="ident">InterpolationError::CantStringifyObjects</span>)
                
        }
    }

    <span class="kw">fn</span> <span class="ident">signed</span>(<span class="kw-2">&amp;</span><span class="self">self</span>) -&gt; <span class="prelude-ty">Result</span><span class="op">&lt;</span><span class="ident">InterpolationValue</span>, <span class="ident">InterpolationError</span><span class="op">&gt;</span> {
        <span class="kw">match</span> <span class="self">self</span> {
            <span class="ident">InterpolationValue::Number</span>(<span class="ident">num</span>,<span class="kw">_</span>) =&gt; <span class="prelude-val">Ok</span>(<span class="ident">InterpolationValue::Number</span>(<span class="kw-2">*</span><span class="ident">num</span>,<span class="bool-val">true</span>)),
            <span class="ident">InterpolationValue::Dice</span>(<span class="ident">dice</span>,<span class="kw">_</span>) =&gt; <span class="prelude-val">Ok</span>(<span class="ident">InterpolationValue::Dice</span>(<span class="ident">dice</span>.<span class="ident">clone</span>(),<span class="bool-val">true</span>)),
            <span class="ident">InterpolationValue::String</span>(<span class="kw">_</span>) =&gt; <span class="prelude-val">Err</span>(<span class="ident">InterpolationError::CantSignString</span>),
            <span class="ident">InterpolationValue::Object</span>(<span class="kw">_</span>) =&gt; <span class="prelude-val">Err</span>(<span class="ident">InterpolationError::CantSignObject</span>)
                
        }

    }

    <span class="kw">fn</span> <span class="ident">multiply</span>(<span class="kw-2">&amp;</span><span class="self">self</span>,<span class="ident">rhs</span>: <span class="kw-2">&amp;</span><span class="ident">InterpolationValue</span>) -&gt; <span class="prelude-ty">Result</span><span class="op">&lt;</span><span class="ident">InterpolationValue</span>,<span class="ident">InterpolationError</span><span class="op">&gt;</span> {
        <span class="kw">match</span> (<span class="self">self</span>,<span class="ident">rhs</span>) {
            (<span class="ident">InterpolationValue::Number</span>(<span class="ident">num</span>,<span class="ident">sign</span>),<span class="ident">InterpolationValue::Number</span>(<span class="ident">rhs</span>,<span class="kw">_</span>)) =&gt; <span class="prelude-val">Ok</span>(<span class="ident">InterpolationValue::Number</span>(<span class="ident">num</span><span class="kw-2">*</span><span class="ident">rhs</span>,<span class="kw-2">*</span><span class="ident">sign</span>)),
            (<span class="ident">InterpolationValue::Dice</span>(<span class="ident">dice</span>,<span class="ident">sign</span>),<span class="ident">InterpolationValue::Number</span>(<span class="ident">rhs</span>,<span class="kw">_</span>)) <span class="op">|</span>
            (<span class="ident">InterpolationValue::Number</span>(<span class="ident">rhs</span>,<span class="ident">sign</span>),<span class="ident">InterpolationValue::Dice</span>(<span class="ident">dice</span>,<span class="kw">_</span>)) =&gt; <span class="prelude-val">Ok</span>(<span class="ident">InterpolationValue::Dice</span>(<span class="ident">dice</span>.<span class="ident">multiply</span>(<span class="ident">rhs</span>),<span class="kw-2">*</span><span class="ident">sign</span>)),
            (<span class="ident">InterpolationValue::String</span>(<span class="kw">_</span>),<span class="kw">_</span>) <span class="op">|</span> (<span class="kw">_</span>,<span class="ident">InterpolationValue::String</span>(<span class="kw">_</span>)) =&gt; <span class="prelude-val">Err</span>(<span class="ident">InterpolationError::CantMultiplyStrings</span>),
            (<span class="ident">InterpolationValue::Object</span>(<span class="kw">_</span>),<span class="kw">_</span>) <span class="op">|</span> (<span class="kw">_</span>,<span class="ident">InterpolationValue::Object</span>(<span class="kw">_</span>)) =&gt; <span class="prelude-val">Err</span>(<span class="ident">InterpolationError::CantMultiplyObjects</span>),
            (<span class="ident">InterpolationValue::Dice</span>(..),<span class="ident">InterpolationValue::Dice</span>(..)) =&gt; <span class="prelude-val">Err</span>(<span class="ident">InterpolationError::CantMultiplyDice</span>),
            
        }
    }

    <span class="kw">fn</span> <span class="ident">divide_ceiling</span>(<span class="kw-2">&amp;</span><span class="self">self</span>,<span class="ident">rhs</span>: <span class="kw-2">&amp;</span><span class="ident">InterpolationValue</span>) -&gt; <span class="prelude-ty">Result</span><span class="op">&lt;</span><span class="ident">InterpolationValue</span>,<span class="ident">InterpolationError</span><span class="op">&gt;</span> {
        <span class="kw">match</span> (<span class="self">self</span>,<span class="ident">rhs</span>) {
            (<span class="ident">InterpolationValue::Number</span>(<span class="ident">num</span>,<span class="ident">sign</span>),<span class="ident">InterpolationValue::Number</span>(<span class="ident">rhs</span>,<span class="kw">_</span>)) =&gt; <span class="prelude-val">Ok</span>(<span class="ident">InterpolationValue::Number</span>(<span class="ident">num</span>.<span class="ident">div_ceiling</span>(<span class="ident">rhs</span>),<span class="kw-2">*</span><span class="ident">sign</span>)),
            (<span class="ident">InterpolationValue::Dice</span>(<span class="ident">dice</span>,<span class="ident">sign</span>),<span class="ident">InterpolationValue::Number</span>(<span class="ident">rhs</span>,<span class="kw">_</span>)) =&gt; <span class="prelude-val">Ok</span>(<span class="ident">InterpolationValue::Dice</span>(<span class="ident">dice</span>.<span class="ident">div_ceiling</span>(<span class="ident">rhs</span>),<span class="kw-2">*</span><span class="ident">sign</span>)),
            (<span class="ident">InterpolationValue::String</span>(<span class="kw">_</span>),<span class="kw">_</span>) <span class="op">|</span> (<span class="kw">_</span>,<span class="ident">InterpolationValue::String</span>(<span class="kw">_</span>)) =&gt; <span class="prelude-val">Err</span>(<span class="ident">InterpolationError::CantDivideStrings</span>),
            (<span class="ident">InterpolationValue::Object</span>(<span class="kw">_</span>),<span class="kw">_</span>) <span class="op">|</span> (<span class="kw">_</span>,<span class="ident">InterpolationValue::Object</span>(<span class="kw">_</span>)) =&gt; <span class="prelude-val">Err</span>(<span class="ident">InterpolationError::CantDivideObjects</span>),
            (<span class="kw">_</span>,<span class="ident">InterpolationValue::Dice</span>(..)) =&gt; <span class="prelude-val">Err</span>(<span class="ident">InterpolationError::CantDivideByDice</span>),

        }
    }

    <span class="kw">fn</span> <span class="ident">divide_floor</span>(<span class="kw-2">&amp;</span><span class="self">self</span>,<span class="ident">rhs</span>: <span class="kw-2">&amp;</span><span class="ident">InterpolationValue</span>) -&gt; <span class="prelude-ty">Result</span><span class="op">&lt;</span><span class="ident">InterpolationValue</span>,<span class="ident">InterpolationError</span><span class="op">&gt;</span> {
        <span class="kw">match</span> (<span class="self">self</span>,<span class="ident">rhs</span>) {
            (<span class="ident">InterpolationValue::Number</span>(<span class="ident">num</span>,<span class="ident">sign</span>),<span class="ident">InterpolationValue::Number</span>(<span class="ident">rhs</span>,<span class="kw">_</span>)) =&gt; <span class="prelude-val">Ok</span>(<span class="ident">InterpolationValue::Number</span>(<span class="ident">num</span>.<span class="ident">nms_div_floor</span>(<span class="ident">rhs</span>),<span class="kw-2">*</span><span class="ident">sign</span>)),
            (<span class="ident">InterpolationValue::Dice</span>(<span class="ident">dice</span>,<span class="ident">sign</span>),<span class="ident">InterpolationValue::Number</span>(<span class="ident">rhs</span>,<span class="kw">_</span>)) =&gt; <span class="prelude-val">Ok</span>(<span class="ident">InterpolationValue::Dice</span>(<span class="ident">dice</span>.<span class="ident">div_floor</span>(<span class="ident">rhs</span>),<span class="kw-2">*</span><span class="ident">sign</span>)),
            (<span class="ident">InterpolationValue::String</span>(<span class="kw">_</span>),<span class="kw">_</span>) <span class="op">|</span> (<span class="kw">_</span>,<span class="ident">InterpolationValue::String</span>(<span class="kw">_</span>)) =&gt; <span class="prelude-val">Err</span>(<span class="ident">InterpolationError::CantDivideStrings</span>),
            (<span class="ident">InterpolationValue::Object</span>(<span class="kw">_</span>),<span class="kw">_</span>) <span class="op">|</span> (<span class="kw">_</span>,<span class="ident">InterpolationValue::Object</span>(<span class="kw">_</span>)) =&gt; <span class="prelude-val">Err</span>(<span class="ident">InterpolationError::CantDivideObjects</span>),
            (<span class="kw">_</span>,<span class="ident">InterpolationValue::Dice</span>(..)) =&gt; <span class="prelude-val">Err</span>(<span class="ident">InterpolationError::CantDivideByDice</span>),

        }
    }

    <span class="kw">fn</span> <span class="ident">add</span>(<span class="kw-2">&amp;</span><span class="self">self</span>,<span class="ident">rhs</span>: <span class="kw-2">&amp;</span><span class="ident">InterpolationValue</span>) -&gt; <span class="prelude-ty">Result</span><span class="op">&lt;</span><span class="ident">InterpolationValue</span>,<span class="ident">InterpolationError</span><span class="op">&gt;</span> {
        <span class="kw">match</span> (<span class="self">self</span>,<span class="ident">rhs</span>) {
            (<span class="ident">InterpolationValue::Number</span>(<span class="ident">num</span>,<span class="ident">sign</span>),<span class="ident">InterpolationValue::Number</span>(<span class="ident">rhs</span>,<span class="kw">_</span>)) =&gt; <span class="prelude-val">Ok</span>(<span class="ident">InterpolationValue::Number</span>(<span class="ident">num</span><span class="op">+</span><span class="ident">rhs</span>,<span class="kw-2">*</span><span class="ident">sign</span>)),
            (<span class="ident">InterpolationValue::Dice</span>(<span class="ident">dice</span>,<span class="ident">sign</span>),<span class="ident">InterpolationValue::Number</span>(<span class="ident">rhs</span>,<span class="kw">_</span>)) <span class="op">|</span>
            (<span class="ident">InterpolationValue::Number</span>(<span class="ident">rhs</span>,<span class="ident">sign</span>),<span class="ident">InterpolationValue::Dice</span>(<span class="ident">dice</span>,<span class="kw">_</span>)) =&gt; <span class="prelude-val">Ok</span>(<span class="ident">InterpolationValue::Dice</span>(<span class="ident">dice</span>.<span class="ident">add</span>(<span class="ident">rhs</span>),<span class="kw-2">*</span><span class="ident">sign</span>)),
            (<span class="ident">InterpolationValue::String</span>(<span class="ident">lhs</span>),<span class="ident">InterpolationValue::String</span>(<span class="ident">rhs</span>)) =&gt; <span class="prelude-val">Ok</span>(<span class="ident">InterpolationValue::String</span>(<span class="ident">Rc::from</span>(<span class="ident">lhs</span>.<span class="ident">as_ref</span>().<span class="ident">to_owned</span>() <span class="op">+</span> <span class="ident">rhs</span>))),
            (<span class="ident">InterpolationValue::Dice</span>(<span class="ident">lhs</span>,<span class="ident">sign</span>),<span class="ident">InterpolationValue::Dice</span>(<span class="ident">rhs</span>,<span class="kw">_</span>)) =&gt; <span class="prelude-val">Ok</span>(<span class="ident">InterpolationValue::Dice</span>(<span class="ident">lhs</span>.<span class="ident">add_dice</span>(<span class="ident">rhs</span>),<span class="kw-2">*</span><span class="ident">sign</span>)),
            (<span class="ident">InterpolationValue::Object</span>(<span class="kw">_</span>),<span class="kw">_</span>) <span class="op">|</span> (<span class="kw">_</span>,<span class="ident">InterpolationValue::Object</span>(<span class="kw">_</span>)) =&gt; <span class="prelude-val">Err</span>(<span class="ident">InterpolationError::CantAddObjects</span>),
            (<span class="ident">InterpolationValue::String</span>(<span class="kw">_</span>),<span class="kw">_</span>) <span class="op">|</span> (<span class="kw">_</span>,<span class="ident">InterpolationValue::String</span>(<span class="kw">_</span>)) =&gt; <span class="prelude-val">Err</span>(<span class="ident">InterpolationError::CantConcatenateNonStrings</span>),

        }
    }

    <span class="kw">fn</span> <span class="ident">subtract</span>(<span class="kw-2">&amp;</span><span class="self">self</span>,<span class="ident">rhs</span>: <span class="kw-2">&amp;</span><span class="ident">InterpolationValue</span>) -&gt; <span class="prelude-ty">Result</span><span class="op">&lt;</span><span class="ident">InterpolationValue</span>,<span class="ident">InterpolationError</span><span class="op">&gt;</span> {
        <span class="kw">match</span> (<span class="self">self</span>,<span class="ident">rhs</span>) {
            (<span class="ident">InterpolationValue::Number</span>(<span class="ident">num</span>,<span class="ident">sign</span>),<span class="ident">InterpolationValue::Number</span>(<span class="ident">rhs</span>,<span class="kw">_</span>)) =&gt; <span class="prelude-val">Ok</span>(<span class="ident">InterpolationValue::Number</span>(<span class="ident">num</span><span class="op">-</span><span class="ident">rhs</span>,<span class="kw-2">*</span><span class="ident">sign</span>)),
            (<span class="ident">InterpolationValue::Dice</span>(<span class="ident">dice</span>,<span class="ident">sign</span>),<span class="ident">InterpolationValue::Number</span>(<span class="ident">rhs</span>,<span class="kw">_</span>)) =&gt; <span class="prelude-val">Ok</span>(<span class="ident">InterpolationValue::Dice</span>(<span class="ident">dice</span>.<span class="ident">subtract</span>(<span class="ident">rhs</span>),<span class="kw-2">*</span><span class="ident">sign</span>)),
            (<span class="ident">InterpolationValue::Number</span>(<span class="ident">num</span>,<span class="ident">sign</span>),<span class="ident">InterpolationValue::Dice</span>(<span class="ident">dice</span>,<span class="kw">_</span>)) =&gt; <span class="prelude-val">Ok</span>(<span class="ident">InterpolationValue::Dice</span>(<span class="ident">dice</span>.<span class="ident">multiply</span>(<span class="kw-2">&amp;</span><span class="op">-</span><span class="number">1</span>).<span class="ident">add</span>(<span class="ident">num</span>),<span class="kw-2">*</span><span class="ident">sign</span>)),
            (<span class="ident">InterpolationValue::Dice</span>(<span class="ident">lhs</span>,<span class="ident">sign</span>),<span class="ident">InterpolationValue::Dice</span>(<span class="ident">rhs</span>,<span class="kw">_</span>)) =&gt; <span class="prelude-val">Ok</span>(<span class="ident">InterpolationValue::Dice</span>(<span class="ident">lhs</span>.<span class="ident">subtract_dice</span>(<span class="ident">rhs</span>),<span class="kw-2">*</span><span class="ident">sign</span>)),
            (<span class="ident">InterpolationValue::Object</span>(<span class="kw">_</span>),<span class="kw">_</span>) <span class="op">|</span> (<span class="kw">_</span>,<span class="ident">InterpolationValue::Object</span>(<span class="kw">_</span>)) =&gt; <span class="prelude-val">Err</span>(<span class="ident">InterpolationError::CantSubtractObjects</span>),
            (<span class="ident">InterpolationValue::String</span>(<span class="kw">_</span>),<span class="kw">_</span>) <span class="op">|</span> (<span class="kw">_</span>,<span class="ident">InterpolationValue::String</span>(<span class="kw">_</span>)) =&gt; <span class="prelude-val">Err</span>(<span class="ident">InterpolationError::CantSubtractStrings</span>),

        }
    }

}

<span class="kw">impl</span> <span class="ident">std::fmt::Display</span> <span class="kw">for</span> <span class="ident">InterpolationValue</span> {

    <span class="kw">fn</span> <span class="ident">fmt</span>(<span class="kw-2">&amp;</span><span class="self">self</span>, <span class="ident">f</span>: <span class="kw-2">&amp;mut</span> <span class="ident">std::fmt::Formatter</span>) -&gt; <span class="prelude-ty">Result</span><span class="op">&lt;</span>(),<span class="ident">std::fmt::Error</span><span class="op">&gt;</span> {
        <span class="kw">match</span> <span class="self">self</span> {
            <span class="ident"><span class="self">Self</span>::Dice</span>(<span class="ident">dice</span>,<span class="ident">sign</span>) =&gt; <span class="kw">if</span> <span class="kw-2">*</span><span class="ident">sign</span> {
                <span class="kw">if</span> <span class="ident">dice</span>.<span class="ident">is_negative</span>() {
                    <span class="macro">write!</span>(<span class="ident">f</span>,<span class="string">&quot;{}&quot;</span>,<span class="ident">dice</span>)
                } <span class="kw">else</span> {
                    <span class="macro">write!</span>(<span class="ident">f</span>,<span class="string">&quot;+{}&quot;</span>,<span class="ident">dice</span>)
                }
            } <span class="kw">else</span> {
                <span class="macro">write!</span>(<span class="ident">f</span>,<span class="string">&quot;{}&quot;</span>,<span class="ident">dice</span>)
            }
            <span class="ident"><span class="self">Self</span>::Number</span>(<span class="ident">num</span>,<span class="ident">sign</span>) =&gt; <span class="kw">if</span> <span class="kw-2">*</span><span class="ident">sign</span> {
                <span class="macro">write!</span>(<span class="ident">f</span>,<span class="string">&quot;{:+}&quot;</span>,<span class="ident">num</span>)
            } <span class="kw">else</span> {
                <span class="macro">write!</span>(<span class="ident">f</span>,<span class="string">&quot;{}&quot;</span>,<span class="ident">num</span>)
            }
            <span class="ident"><span class="self">Self</span>::String</span>(<span class="ident">str</span>) =&gt; <span class="macro">write!</span>(<span class="ident">f</span>,<span class="string">&quot;{}&quot;</span>,<span class="ident">str</span>),
            <span class="ident"><span class="self">Self</span>::Object</span>(<span class="kw">_</span>) =&gt; <span class="macro">write!</span>(<span class="ident">f</span>,<span class="string">&quot;&lt;object&gt;&quot;</span>)
        }
   }
}

<span class="attribute">#[<span class="ident">derive</span>(<span class="ident">Debug</span>)]</span>
<span class="kw">enum</span> <span class="ident">InterpolationOperation</span> {
    <span class="comment">// creates a string value and puts it on the stack</span>
    <span class="ident">CreateString</span>(<span class="ident">Rc</span><span class="op">&lt;</span><span class="ident">str</span><span class="op">&gt;</span>),
    <span class="comment">// creates a number value and puts it on the stack</span>
    <span class="ident">CreateNumber</span>(<span class="ident">isize</span>),
    <span class="comment">// creates a dice value and puts it on the stack</span>
    <span class="ident">CreateDice</span>(<span class="ident">Dice</span>),
    <span class="comment">// gets the specified variable by name and puts it on the stack</span>
    <span class="ident">GetVariable</span>(<span class="ident">Rc</span><span class="op">&lt;</span><span class="ident">str</span><span class="op">&gt;</span>),
    <span class="comment">// replaces the value on the top of the stack with  the result of calling &#39;get_index&#39; on it</span>
    <span class="ident">GetIndex</span>(<span class="ident">usize</span>),
    <span class="comment">// replaces the value at the top of the stack with the result of calling &#39;get_property&#39; on it</span>
    <span class="ident">GetProperty</span>(<span class="ident">Rc</span><span class="op">&lt;</span><span class="ident">str</span><span class="op">&gt;</span>),
    <span class="comment">// replaces the value at the top of the stack with the result of calling &#39;negate&#39; on it.</span>
    <span class="ident">Negate</span>,
    <span class="comment">// replaces the value at the top of the stack with the result of calling &#39;stringify&#39; on it.</span>
    <span class="ident">Stringify</span>,
    <span class="comment">// replaces the value at the top of the stack with the result of calling &#39;sign&#39; on it</span>
    <span class="ident">Sign</span>,
    <span class="comment">// takes two values off the stack and replaces with the result of calling multiply on them.</span>
    <span class="ident">Multiply</span>,
    <span class="comment">// takes two values off the stack and replaces with the result of calling floor_divide on them.</span>
    <span class="ident">FloorDivide</span>,
    <span class="comment">// takes two values off the stack and replaces with the result of calling ceiling_divide on them.</span>
    <span class="ident">CeilingDivide</span>,
    <span class="comment">// takes two values off the stack and replaces with the result of calling add on them.</span>
    <span class="ident">Add</span>,
    <span class="comment">// takes two values off the stack and replaces with the result of calling subtract on them.</span>
    <span class="ident">Subtract</span>,
    <span class="comment">// takes value off the stack, stringifies it if necessary, and appends it to the current string</span>
    <span class="ident">Append</span>,
    
    <span class="comment">// structured text operations</span>
    <span class="comment">// if italic mode is on, then throw an error, otherwise:</span>
    <span class="comment">// - put the current string into a span according to the current italic and bold modes, add to current span list, and clear current span</span>
    <span class="comment">// - set the italic mode to on</span>
    <span class="ident">StartItalic</span>,
    <span class="comment">// if bold mode is on, then throw an error, otherwise:</span>
    <span class="comment">// - put the current string into a span according to the current italic and bold modes, add to current span list, and clear current span</span>
    <span class="comment">// - set the bold mode to on</span>
    <span class="ident">StartBold</span>,
    <span class="comment">// if italic mode is off, then throw an error, otherwise:</span>
    <span class="comment">// - put the current string into a span according to the current italic and bold modes, add to current span list, and clear current span</span>
    <span class="comment">// - set the italic mode to off</span>
    <span class="ident">EndItalic</span>,
    <span class="comment">// if bold mode is off, then throw an error, otherwise:</span>
    <span class="comment">// - put the current string into a span according to the current italic and bold modes, add to current span list, and clear current span</span>
    <span class="comment">// - set the bold mode to off</span>
    <span class="ident">EndBold</span>,

    <span class="comment">// - put the current string into a span according to the current italic and bold modes, add to current span list, and clear current span</span>
    <span class="comment">// - add a block using the current heading and current span list, according to the current mode</span>
    <span class="comment">// - set current mode to paragraph</span>
    <span class="ident">StartParagraph</span>,
    <span class="comment">// - put the current string into a span according to the current italic and bold modes, add to current span list, and clear current span</span>
    <span class="comment">// - add a block using the current heading and current span list, according to the current mode</span>
    <span class="comment">// - set current mode to list item</span>
    <span class="ident">StartListItem</span>,
    <span class="comment">// - put the current string into a span according to the current italic and bold modes, add to current span list, and clear current span</span>
    <span class="comment">// - set the current span list as the current heading, and clear the current span list</span>
    <span class="ident">EndBlockStart</span>,


}



<span class="comment">/*
document = expression+ 
*/</span>
<span class="kw">struct</span> <span class="ident">Document</span> {
    <span class="ident">operations</span>: <span class="ident">Vec</span><span class="op">&lt;</span>(<span class="ident">InterpolationOperation</span>,<span class="ident">PositionRange</span>)<span class="op">&gt;</span>
}

<span class="kw">impl</span> <span class="ident">Document</span> {

<span class="comment">/*
variable_expression = identifier (&#39;.&#39; identifier)*
*/</span>
    <span class="kw">fn</span> <span class="ident">parse_variable_expression</span><span class="op">&lt;</span><span class="ident">Source</span>: <span class="ident">Iterator</span><span class="op">&lt;</span><span class="ident">Item</span><span class="op">=</span><span class="ident">char</span><span class="op">&gt;</span><span class="op">&gt;</span>(<span class="ident">tokenizer</span>: <span class="kw-2">&amp;mut</span> <span class="ident">InterpolationTokenizer</span><span class="op">&lt;</span><span class="ident">Source</span><span class="op">&gt;</span>, <span class="ident">operations</span>: <span class="kw-2">&amp;mut</span> <span class="ident">Vec</span><span class="op">&lt;</span>(<span class="ident">InterpolationOperation</span>,<span class="ident">PositionRange</span>)<span class="op">&gt;</span>, <span class="ident">identifier</span>: <span class="ident">Rc</span><span class="op">&lt;</span><span class="ident">str</span><span class="op">&gt;</span>, <span class="ident">position</span>: <span class="ident">PositionRange</span>) -&gt; <span class="prelude-ty">Result</span><span class="op">&lt;</span>(),<span class="ident">InterpolationErrorDetails</span><span class="op">&gt;</span> {
        <span class="ident">operations</span>.<span class="ident">push</span>((<span class="ident">InterpolationOperation::GetVariable</span>(<span class="ident">identifier</span>.<span class="ident">clone</span>()),<span class="ident">position</span>.<span class="ident">clone</span>()));
        <span class="ident">tokenizer</span>.<span class="ident">next_ok</span>()<span class="question-mark">?</span>;
        <span class="kw">while</span> <span class="kw">let</span> <span class="prelude-val">Some</span>(<span class="prelude-val">Ok</span>((<span class="ident">token</span>,<span class="kw">_</span>))) <span class="op">=</span> <span class="kw-2">&amp;</span><span class="ident">tokenizer</span>.<span class="ident">current</span> {
            <span class="kw">match</span> <span class="ident">token</span> {
                <span class="ident">Token::Dot</span> =&gt; {
                    <span class="kw">match</span> <span class="ident">tokenizer</span>.<span class="ident">next_ok</span>()<span class="question-mark">?</span> {
                        <span class="prelude-val">Some</span>((<span class="ident">Token::Identifier</span>(<span class="ident">str</span>), <span class="ident">position</span>)) =&gt; 
                            <span class="ident">operations</span>.<span class="ident">push</span>((<span class="ident">InterpolationOperation::GetProperty</span>(<span class="ident">str</span>.<span class="ident">clone</span>()),<span class="ident">position</span>.<span class="ident">clone</span>())), 
                        <span class="prelude-val">Some</span>((<span class="ident">Token::Number</span>(<span class="ident">num</span>), <span class="ident">position</span>)) =&gt; 
                            <span class="ident">operations</span>.<span class="ident">push</span>((<span class="ident">InterpolationOperation::GetIndex</span>(<span class="ident">num</span> <span class="kw">as</span> <span class="ident">usize</span>),<span class="ident">position</span>.<span class="ident">clone</span>())), 
                        <span class="kw">_</span> =&gt; 
                            <span class="prelude-val">Err</span>(<span class="ident">InterpolationError::ExpectedIdentifier</span>(<span class="macro">format!</span>(<span class="string">&quot;{:?}&quot;</span>,<span class="ident">tokenizer</span>.<span class="ident">current</span>)).<span class="ident">details</span>(<span class="kw-2">&amp;</span><span class="ident">tokenizer</span>.<span class="ident">source_name</span>,<span class="kw-2">&amp;</span><span class="ident">tokenizer</span>.<span class="ident">position</span>))<span class="question-mark">?</span>
                    }
                },
                <span class="kw">_</span> =&gt; <span class="kw">break</span>
            }

        }

        <span class="prelude-val">Ok</span>(())
                
    }



<span class="comment">/*
term = string_literal | number_literal | dice_literal | variable_reference | &#39;(&#39; expression &#39;)&#39;
*/</span>
    <span class="kw">fn</span> <span class="ident">parse_term</span><span class="op">&lt;</span><span class="ident">Source</span>: <span class="ident">Iterator</span><span class="op">&lt;</span><span class="ident">Item</span><span class="op">=</span><span class="ident">char</span><span class="op">&gt;</span><span class="op">&gt;</span>(<span class="ident">tokenizer</span>: <span class="kw-2">&amp;mut</span> <span class="ident">InterpolationTokenizer</span><span class="op">&lt;</span><span class="ident">Source</span><span class="op">&gt;</span>, <span class="ident">operations</span>: <span class="kw-2">&amp;mut</span> <span class="ident">Vec</span><span class="op">&lt;</span>(<span class="ident">InterpolationOperation</span>,<span class="ident">PositionRange</span>)<span class="op">&gt;</span>) -&gt; <span class="prelude-ty">Result</span><span class="op">&lt;</span>(),<span class="ident">InterpolationErrorDetails</span><span class="op">&gt;</span> {

        <span class="kw">match</span> <span class="kw-2">&amp;</span><span class="ident">tokenizer</span>.<span class="ident">current</span> {
            <span class="prelude-val">Some</span>(<span class="prelude-val">Ok</span>((<span class="ident">token</span>, <span class="ident">position</span>))) =&gt; <span class="prelude-val">Ok</span>(<span class="kw">match</span> <span class="kw-2">&amp;</span><span class="ident">token</span> {
                <span class="ident">Token::String</span>(<span class="ident">str</span>) =&gt; {
                    <span class="ident">operations</span>.<span class="ident">push</span>((<span class="ident">InterpolationOperation::CreateString</span>(<span class="ident">str</span>.<span class="ident">clone</span>()),<span class="ident">position</span>.<span class="ident">clone</span>()));
                    <span class="ident">tokenizer</span>.<span class="ident">next_ok</span>()<span class="question-mark">?</span>;
                }
                <span class="ident">Token::Number</span>(<span class="ident">num</span>) =&gt; {
                    <span class="ident">operations</span>.<span class="ident">push</span>((<span class="ident">InterpolationOperation::CreateNumber</span>(<span class="kw-2">*</span><span class="ident">num</span>),<span class="ident">position</span>.<span class="ident">clone</span>()));
                    <span class="ident">tokenizer</span>.<span class="ident">next_ok</span>()<span class="question-mark">?</span>;
                },
                <span class="ident">Token::Dice</span>(<span class="ident">dice</span>) =&gt; {
                    <span class="ident">operations</span>.<span class="ident">push</span>((<span class="ident">InterpolationOperation::CreateDice</span>(<span class="ident">dice</span>.<span class="ident">clone</span>()),<span class="ident">position</span>.<span class="ident">clone</span>()));
                    <span class="ident">tokenizer</span>.<span class="ident">next_ok</span>()<span class="question-mark">?</span>;
                },
                <span class="ident">Token::OpenParenthesis</span> =&gt; {
                    <span class="ident">tokenizer</span>.<span class="ident">next_ok</span>()<span class="question-mark">?</span>;
                    <span class="ident"><span class="self">Self</span>::parse_expression</span>(<span class="ident">tokenizer</span>,<span class="ident">operations</span>)<span class="question-mark">?</span>;
                    <span class="kw">if</span> <span class="kw">let</span> <span class="prelude-val">Some</span>((<span class="ident">Token::CloseParenthesis</span>, ..)) <span class="op">=</span> <span class="ident">tokenizer</span>.<span class="ident">next_ok</span>()<span class="question-mark">?</span> {
                    } <span class="kw">else</span> {
                        <span class="prelude-val">Err</span>(<span class="ident">InterpolationError::ExpectedCloseParen</span>(<span class="macro">format!</span>(<span class="string">&quot;{:?}&quot;</span>,<span class="ident">tokenizer</span>.<span class="ident">current</span>)).<span class="ident">details</span>(<span class="kw-2">&amp;</span><span class="ident">tokenizer</span>.<span class="ident">source_name</span>,<span class="kw-2">&amp;</span><span class="ident">tokenizer</span>.<span class="ident">position</span>))<span class="question-mark">?</span>
                    }
                },
                <span class="ident">Token::Identifier</span>(<span class="ident">str</span>) =&gt; {
                    <span class="kw">let</span> <span class="ident">str</span> <span class="op">=</span> <span class="ident">str</span>.<span class="ident">clone</span>();
                    <span class="kw">let</span> <span class="ident">position</span> <span class="op">=</span> <span class="ident">position</span>.<span class="ident">clone</span>();
                    <span class="ident"><span class="self">Self</span>::parse_variable_expression</span>(<span class="ident">tokenizer</span>,<span class="ident">operations</span>,<span class="ident">str</span>,<span class="ident">position</span>)<span class="question-mark">?</span>
                },
                <span class="kw">_</span> =&gt; <span class="prelude-val">Err</span>(<span class="ident">InterpolationError::ExpectedExpression</span>(<span class="macro">format!</span>(<span class="string">&quot;{:?}&quot;</span>,<span class="ident">token</span>)).<span class="ident">details</span>(<span class="kw-2">&amp;</span><span class="ident">tokenizer</span>.<span class="ident">source_name</span>,<span class="kw-2">&amp;</span><span class="ident">tokenizer</span>.<span class="ident">position</span>))<span class="question-mark">?</span>
            }),
            <span class="prelude-val">Some</span>(<span class="prelude-val">Err</span>(<span class="ident">token</span>)) =&gt; <span class="prelude-val">Err</span>(<span class="ident">token</span>.<span class="ident">into</span>()),
            <span class="prelude-val">None</span> =&gt; <span class="prelude-val">Err</span>(<span class="ident">InterpolationError::ExpectedExpression</span>(<span class="string">&quot;end of file&quot;</span>.<span class="ident">to_owned</span>()).<span class="ident">details</span>(<span class="kw-2">&amp;</span><span class="ident">tokenizer</span>.<span class="ident">source_name</span>,<span class="kw-2">&amp;</span><span class="ident">tokenizer</span>.<span class="ident">position</span>))
        }

    }




<span class="comment">/*
unary_expression = (&#39;-&#39;)* term
*/</span>
    <span class="kw">fn</span> <span class="ident">parse_unary</span><span class="op">&lt;</span><span class="ident">Source</span>: <span class="ident">Iterator</span><span class="op">&lt;</span><span class="ident">Item</span><span class="op">=</span><span class="ident">char</span><span class="op">&gt;</span><span class="op">&gt;</span>(<span class="ident">tokenizer</span>: <span class="kw-2">&amp;mut</span> <span class="ident">InterpolationTokenizer</span><span class="op">&lt;</span><span class="ident">Source</span><span class="op">&gt;</span>, <span class="ident">operations</span>: <span class="kw-2">&amp;mut</span> <span class="ident">Vec</span><span class="op">&lt;</span>(<span class="ident">InterpolationOperation</span>,<span class="ident">PositionRange</span>)<span class="op">&gt;</span>) -&gt; <span class="prelude-ty">Result</span><span class="op">&lt;</span>(),<span class="ident">InterpolationErrorDetails</span><span class="op">&gt;</span> {
        <span class="kw">let</span> <span class="kw-2">mut</span> <span class="ident">unary_operations</span> <span class="op">=</span> <span class="macro">vec!</span>[];

        <span class="kw">while</span> <span class="kw">let</span> <span class="prelude-val">Some</span>(<span class="prelude-val">Ok</span>((<span class="ident">token</span>,<span class="ident">position</span>))) <span class="op">=</span> <span class="kw-2">&amp;</span><span class="ident">tokenizer</span>.<span class="ident">current</span> {
            <span class="kw">match</span> <span class="ident">token</span> {
                <span class="ident">Token::Minus</span> =&gt; {
                    <span class="ident">unary_operations</span>.<span class="ident">push</span>((<span class="ident">InterpolationOperation::Negate</span>,<span class="ident">position</span>.<span class="ident">clone</span>()));
                    <span class="ident">tokenizer</span>.<span class="ident">next_ok</span>()<span class="question-mark">?</span>;
                },
                <span class="ident">Token::Dollar</span> =&gt; {
                    <span class="ident">unary_operations</span>.<span class="ident">push</span>((<span class="ident">InterpolationOperation::Stringify</span>,<span class="ident">position</span>.<span class="ident">clone</span>()));
                    <span class="ident">tokenizer</span>.<span class="ident">next_ok</span>()<span class="question-mark">?</span>;
                },
                <span class="ident">Token::Plus</span> =&gt; {
                    <span class="ident">unary_operations</span>.<span class="ident">push</span>((<span class="ident">InterpolationOperation::Sign</span>,<span class="ident">position</span>.<span class="ident">clone</span>()));
                    <span class="ident">tokenizer</span>.<span class="ident">next_ok</span>()<span class="question-mark">?</span>;
                }
                <span class="kw">_</span> =&gt; <span class="kw">break</span>
            }

        }


        <span class="ident"><span class="self">Self</span>::parse_term</span>(<span class="ident">tokenizer</span>,<span class="ident">operations</span>)<span class="question-mark">?</span>;
        
        <span class="comment">// reverse through the things to push from inner to outer</span>
        <span class="kw">for</span> <span class="ident">op</span> <span class="kw">in</span> <span class="ident">unary_operations</span>.<span class="ident">into_iter</span>().<span class="ident">rev</span>() {
            <span class="ident">operations</span>.<span class="ident">push</span>(<span class="ident">op</span>)
        };
        <span class="prelude-val">Ok</span>(())

    }


<span class="comment">/*
mul_expression = unary ((&#39;*&#39; | &#39;/&lt;&#39; &#39;/&gt;&#39;) unary)*
*/</span>
    <span class="kw">fn</span> <span class="ident">parse_mul</span><span class="op">&lt;</span><span class="ident">Source</span>: <span class="ident">Iterator</span><span class="op">&lt;</span><span class="ident">Item</span><span class="op">=</span><span class="ident">char</span><span class="op">&gt;</span><span class="op">&gt;</span>(<span class="ident">tokenizer</span>: <span class="kw-2">&amp;mut</span> <span class="ident">InterpolationTokenizer</span><span class="op">&lt;</span><span class="ident">Source</span><span class="op">&gt;</span>, <span class="ident">operations</span>: <span class="kw-2">&amp;mut</span> <span class="ident">Vec</span><span class="op">&lt;</span>(<span class="ident">InterpolationOperation</span>,<span class="ident">PositionRange</span>)<span class="op">&gt;</span>) -&gt; <span class="prelude-ty">Result</span><span class="op">&lt;</span>(),<span class="ident">InterpolationErrorDetails</span><span class="op">&gt;</span> {
        <span class="ident"><span class="self">Self</span>::parse_unary</span>(<span class="ident">tokenizer</span>,<span class="ident">operations</span>)<span class="question-mark">?</span>;

        <span class="kw">while</span> <span class="kw">let</span> <span class="prelude-val">Some</span>(<span class="prelude-val">Ok</span>((<span class="ident">token</span>,<span class="ident">position</span>))) <span class="op">=</span> <span class="kw-2">&amp;</span><span class="ident">tokenizer</span>.<span class="ident">current</span> {
            <span class="kw">let</span> <span class="ident">position</span> <span class="op">=</span> <span class="ident">position</span>.<span class="ident">clone</span>();
            <span class="kw">match</span> <span class="ident">token</span> {
                <span class="ident">Token::Asterisk</span> =&gt; {
                    <span class="ident"><span class="self">Self</span>::parse_unary</span>(<span class="ident">tokenizer</span>,<span class="ident">operations</span>)<span class="question-mark">?</span>;
                    <span class="ident">operations</span>.<span class="ident">push</span>((<span class="ident">InterpolationOperation::Multiply</span>,<span class="ident">position</span>));
                },
                <span class="ident">Token::SlashGreaterThan</span> =&gt; {
                    <span class="ident"><span class="self">Self</span>::parse_unary</span>(<span class="ident">tokenizer</span>,<span class="ident">operations</span>)<span class="question-mark">?</span>;
                    <span class="ident">operations</span>.<span class="ident">push</span>((<span class="ident">InterpolationOperation::CeilingDivide</span>,<span class="ident">position</span>));
                },
                <span class="ident">Token::SlashLessThan</span> =&gt; {
                    <span class="ident"><span class="self">Self</span>::parse_unary</span>(<span class="ident">tokenizer</span>,<span class="ident">operations</span>)<span class="question-mark">?</span>;
                    <span class="ident">operations</span>.<span class="ident">push</span>((<span class="ident">InterpolationOperation::FloorDivide</span>,<span class="ident">position</span>));
                },
                <span class="kw">_</span> =&gt; <span class="kw">break</span>
            }

        }

        <span class="prelude-val">Ok</span>(())
    }


<span class="comment">/*
add_expression = mul_expression ((&#39;+&#39; | &#39;-&#39;) mul_expression)*
*/</span>
    <span class="kw">fn</span> <span class="ident">parse_add</span><span class="op">&lt;</span><span class="ident">Source</span>: <span class="ident">Iterator</span><span class="op">&lt;</span><span class="ident">Item</span><span class="op">=</span><span class="ident">char</span><span class="op">&gt;</span><span class="op">&gt;</span>(<span class="ident">tokenizer</span>: <span class="kw-2">&amp;mut</span> <span class="ident">InterpolationTokenizer</span><span class="op">&lt;</span><span class="ident">Source</span><span class="op">&gt;</span>, <span class="ident">operations</span>: <span class="kw-2">&amp;mut</span> <span class="ident">Vec</span><span class="op">&lt;</span>(<span class="ident">InterpolationOperation</span>,<span class="ident">PositionRange</span>)<span class="op">&gt;</span>) -&gt; <span class="prelude-ty">Result</span><span class="op">&lt;</span>(),<span class="ident">InterpolationErrorDetails</span><span class="op">&gt;</span> {
        <span class="ident"><span class="self">Self</span>::parse_mul</span>(<span class="ident">tokenizer</span>,<span class="ident">operations</span>)<span class="question-mark">?</span>;

        <span class="kw">while</span> <span class="kw">let</span> <span class="prelude-val">Some</span>(<span class="prelude-val">Ok</span>((<span class="ident">token</span>,<span class="ident">position</span>))) <span class="op">=</span> <span class="kw-2">&amp;</span><span class="ident">tokenizer</span>.<span class="ident">current</span> {
            <span class="kw">let</span> <span class="ident">position</span> <span class="op">=</span> <span class="ident">position</span>.<span class="ident">clone</span>();
            <span class="kw">match</span> <span class="ident">token</span> {
                <span class="ident">Token::Plus</span> =&gt; {
                    <span class="ident"><span class="self">Self</span>::parse_mul</span>(<span class="ident">tokenizer</span>,<span class="ident">operations</span>)<span class="question-mark">?</span>;
                    <span class="ident">operations</span>.<span class="ident">push</span>((<span class="ident">InterpolationOperation::Add</span>,<span class="ident">position</span>));
                },
                <span class="ident">Token::Minus</span> =&gt; {
                    <span class="ident"><span class="self">Self</span>::parse_mul</span>(<span class="ident">tokenizer</span>,<span class="ident">operations</span>)<span class="question-mark">?</span>;
                    <span class="ident">operations</span>.<span class="ident">push</span>((<span class="ident">InterpolationOperation::Subtract</span>,<span class="ident">position</span>));
                },
                <span class="kw">_</span> =&gt; <span class="kw">break</span>
            }

        }

        <span class="prelude-val">Ok</span>(())
    }
    
    <span class="kw">fn</span> <span class="ident">parse_command_arguments</span><span class="op">&lt;</span><span class="ident">Source</span>: <span class="ident">Iterator</span><span class="op">&lt;</span><span class="ident">Item</span><span class="op">=</span><span class="ident">char</span><span class="op">&gt;</span><span class="op">&gt;</span>(<span class="ident">tokenizer</span>: <span class="kw-2">&amp;mut</span> <span class="ident">InterpolationTokenizer</span><span class="op">&lt;</span><span class="ident">Source</span><span class="op">&gt;</span>, <span class="ident">operations</span>: <span class="kw-2">&amp;mut</span> <span class="ident">Vec</span><span class="op">&lt;</span>(<span class="ident">InterpolationOperation</span>,<span class="ident">PositionRange</span>)<span class="op">&gt;</span>) -&gt; <span class="prelude-ty">Result</span><span class="op">&lt;</span><span class="ident">PositionRange</span>,<span class="ident">InterpolationErrorDetails</span><span class="op">&gt;</span> {
        <span class="kw">if</span> <span class="kw">let</span> <span class="prelude-val">Some</span>((<span class="ident">Token::OpenParenthesis</span>,<span class="kw">_</span>)) <span class="op">=</span> <span class="ident">tokenizer</span>.<span class="ident">next_ok</span>()<span class="question-mark">?</span> {
            <span class="ident">tokenizer</span>.<span class="ident">next_ok</span>()<span class="question-mark">?</span>;
            <span class="kw">loop</span> {
                <span class="kw">if</span> <span class="kw">let</span> <span class="prelude-val">Some</span>(<span class="prelude-val">Ok</span>((<span class="ident">Token::CloseParenthesis</span>,<span class="ident">position</span>))) <span class="op">=</span> <span class="kw-2">&amp;</span><span class="ident">tokenizer</span>.<span class="ident">current</span> {
                    <span class="kw">let</span> <span class="ident">position</span> <span class="op">=</span> <span class="ident">position</span>.<span class="ident">clone</span>();
                    <span class="ident">tokenizer</span>.<span class="ident">next_ok</span>()<span class="question-mark">?</span>;
                    <span class="kw">break</span> <span class="prelude-val">Ok</span>(<span class="ident">position</span>);
                }
                
                <span class="ident"><span class="self">Self</span>::parse_expression</span>(<span class="ident">tokenizer</span>, <span class="ident">operations</span>)<span class="question-mark">?</span>;
                <span class="ident">operations</span>.<span class="ident">push</span>((<span class="ident">InterpolationOperation::Append</span>,<span class="ident">tokenizer</span>.<span class="ident">position</span>.<span class="ident">clone</span>()));
            }
        } <span class="kw">else</span> {
            <span class="prelude-val">Ok</span>(<span class="ident">tokenizer</span>.<span class="ident">position</span>.<span class="ident">clone</span>())
        }

    }
    
    <span class="kw">fn</span> <span class="ident">parse_command</span><span class="op">&lt;</span><span class="ident">Source</span>: <span class="ident">Iterator</span><span class="op">&lt;</span><span class="ident">Item</span><span class="op">=</span><span class="ident">char</span><span class="op">&gt;</span><span class="op">&gt;</span>(<span class="ident">tokenizer</span>: <span class="kw-2">&amp;mut</span> <span class="ident">InterpolationTokenizer</span><span class="op">&lt;</span><span class="ident">Source</span><span class="op">&gt;</span>, <span class="ident">operations</span>: <span class="kw-2">&amp;mut</span> <span class="ident">Vec</span><span class="op">&lt;</span>(<span class="ident">InterpolationOperation</span>,<span class="ident">PositionRange</span>)<span class="op">&gt;</span>, <span class="ident">keyword</span>: <span class="ident">StructureKeyword</span>, <span class="ident">position</span>: <span class="ident">PositionRange</span>) -&gt; <span class="prelude-ty">Result</span><span class="op">&lt;</span>(),<span class="ident">InterpolationErrorDetails</span><span class="op">&gt;</span> {
        <span class="kw">match</span> <span class="ident">keyword</span> {
            <span class="ident">StructureKeyword::Bold</span> =&gt; {
                <span class="ident">operations</span>.<span class="ident">push</span>((<span class="ident">InterpolationOperation::StartBold</span>,<span class="ident">position</span>.<span class="ident">clone</span>()));
                <span class="kw">let</span> <span class="ident">position</span> <span class="op">=</span> <span class="ident"><span class="self">Self</span>::parse_command_arguments</span>(<span class="ident">tokenizer</span>, <span class="ident">operations</span>)<span class="question-mark">?</span>;
                <span class="ident">operations</span>.<span class="ident">push</span>((<span class="ident">InterpolationOperation::EndBold</span>,<span class="ident">position</span>.<span class="ident">clone</span>()));
            },
            <span class="ident">StructureKeyword::Italic</span> =&gt; {
                <span class="ident">operations</span>.<span class="ident">push</span>((<span class="ident">InterpolationOperation::StartItalic</span>,<span class="ident">position</span>.<span class="ident">clone</span>()));
                <span class="kw">let</span> <span class="ident">position</span> <span class="op">=</span> <span class="ident"><span class="self">Self</span>::parse_command_arguments</span>(<span class="ident">tokenizer</span>, <span class="ident">operations</span>)<span class="question-mark">?</span>;
                <span class="ident">operations</span>.<span class="ident">push</span>((<span class="ident">InterpolationOperation::EndItalic</span>,<span class="ident">position</span>.<span class="ident">clone</span>()));
            },
            <span class="ident">StructureKeyword::Sub</span> =&gt; {
                <span class="ident">operations</span>.<span class="ident">push</span>((<span class="ident">InterpolationOperation::StartListItem</span>,<span class="ident">position</span>.<span class="ident">clone</span>()));
                <span class="kw">let</span> <span class="ident">position</span> <span class="op">=</span> <span class="ident"><span class="self">Self</span>::parse_command_arguments</span>(<span class="ident">tokenizer</span>, <span class="ident">operations</span>)<span class="question-mark">?</span>;
                <span class="ident">operations</span>.<span class="ident">push</span>((<span class="ident">InterpolationOperation::EndBlockStart</span>,<span class="ident">position</span>.<span class="ident">clone</span>()));
            },
            <span class="ident">StructureKeyword::Par</span> =&gt; {
                <span class="ident">operations</span>.<span class="ident">push</span>((<span class="ident">InterpolationOperation::StartParagraph</span>,<span class="ident">position</span>.<span class="ident">clone</span>()));
                <span class="kw">let</span> <span class="ident">position</span> <span class="op">=</span> <span class="ident"><span class="self">Self</span>::parse_command_arguments</span>(<span class="ident">tokenizer</span>, <span class="ident">operations</span>)<span class="question-mark">?</span>;
                <span class="ident">operations</span>.<span class="ident">push</span>((<span class="ident">InterpolationOperation::EndBlockStart</span>,<span class="ident">position</span>.<span class="ident">clone</span>()));
            }
        }
        <span class="prelude-val">Ok</span>(())
    }


<span class="comment">/*
expression = text | add_expression
*/</span>
    <span class="kw">fn</span> <span class="ident">parse_expression</span><span class="op">&lt;</span><span class="ident">Source</span>: <span class="ident">Iterator</span><span class="op">&lt;</span><span class="ident">Item</span><span class="op">=</span><span class="ident">char</span><span class="op">&gt;</span><span class="op">&gt;</span>(<span class="ident">tokenizer</span>: <span class="kw-2">&amp;mut</span> <span class="ident">InterpolationTokenizer</span><span class="op">&lt;</span><span class="ident">Source</span><span class="op">&gt;</span>, <span class="ident">operations</span>: <span class="kw-2">&amp;mut</span> <span class="ident">Vec</span><span class="op">&lt;</span>(<span class="ident">InterpolationOperation</span>,<span class="ident">PositionRange</span>)<span class="op">&gt;</span>) -&gt; <span class="prelude-ty">Result</span><span class="op">&lt;</span>(),<span class="ident">InterpolationErrorDetails</span><span class="op">&gt;</span> {
        <span class="kw">match</span> <span class="kw-2">&amp;</span><span class="ident">tokenizer</span>.<span class="ident">current</span> {
            <span class="prelude-val">Some</span>(<span class="prelude-val">Ok</span>((<span class="ident">Token::Text</span>(<span class="ident">str</span>), <span class="ident">position</span>))) =&gt; {
                <span class="ident">operations</span>.<span class="ident">push</span>((<span class="ident">InterpolationOperation::CreateString</span>(<span class="ident">str</span>.<span class="ident">clone</span>()),<span class="ident">position</span>.<span class="ident">clone</span>()));
                <span class="ident">tokenizer</span>.<span class="ident">next_ok</span>()<span class="question-mark">?</span>;
                <span class="prelude-val">Ok</span>(())
            },
            <span class="kw">_</span> =&gt; <span class="prelude-val">Ok</span>(<span class="ident"><span class="self">Self</span>::parse_add</span>(<span class="ident">tokenizer</span>,<span class="ident">operations</span>)<span class="question-mark">?</span>)
        }


    }

<span class="comment">/*
document = (command | expression)*
*/</span>
    <span class="kw">fn</span> <span class="ident">parse</span><span class="op">&lt;</span><span class="ident">Source</span>: <span class="ident">Iterator</span><span class="op">&lt;</span><span class="ident">Item</span><span class="op">=</span><span class="ident">char</span><span class="op">&gt;</span><span class="op">&gt;</span>(<span class="ident">tokenizer</span>: <span class="kw-2">&amp;mut</span> <span class="ident">InterpolationTokenizer</span><span class="op">&lt;</span><span class="ident">Source</span><span class="op">&gt;</span>) -&gt; <span class="prelude-ty">Result</span><span class="op">&lt;</span><span class="self">Self</span>,<span class="ident">InterpolationErrorDetails</span><span class="op">&gt;</span> {
        <span class="kw">let</span> <span class="kw-2">mut</span> <span class="ident">operations</span> <span class="op">=</span> <span class="macro">vec!</span>[];
        <span class="ident">tokenizer</span>.<span class="ident">next_ok</span>()<span class="question-mark">?</span>;

        <span class="kw">while</span> <span class="kw">let</span> <span class="prelude-val">Some</span>(<span class="kw">_</span>) <span class="op">=</span> <span class="ident">tokenizer</span>.<span class="ident">current</span> {
            <span class="kw">if</span> <span class="kw">let</span> <span class="prelude-val">Some</span>(<span class="prelude-val">Ok</span>((<span class="ident">Token::Keyword</span>(<span class="ident">keyword</span>),<span class="ident">position</span>))) <span class="op">=</span> <span class="kw-2">&amp;</span><span class="ident">tokenizer</span>.<span class="ident">current</span> {
                <span class="kw">let</span> <span class="ident">keyword</span> <span class="op">=</span> <span class="ident">keyword</span>.<span class="ident">clone</span>();
                <span class="kw">let</span> <span class="ident">position</span> <span class="op">=</span> <span class="ident">position</span>.<span class="ident">clone</span>();
                <span class="ident"><span class="self">Self</span>::parse_command</span>(<span class="ident">tokenizer</span>,<span class="kw-2">&amp;mut</span> <span class="ident">operations</span>,<span class="ident">keyword</span>.<span class="ident">clone</span>(),<span class="ident">position</span>.<span class="ident">clone</span>())<span class="question-mark">?</span>;
            } <span class="kw">else</span> {
                <span class="ident"><span class="self">Self</span>::parse_expression</span>(<span class="ident">tokenizer</span>,<span class="kw-2">&amp;mut</span> <span class="ident">operations</span>)<span class="question-mark">?</span>;
                <span class="ident">operations</span>.<span class="ident">push</span>((<span class="ident">InterpolationOperation::Append</span>,<span class="ident">tokenizer</span>.<span class="ident">position</span>.<span class="ident">clone</span>()));
            }
        }


        
    
        <span class="prelude-val">Ok</span>(<span class="self">Self</span> {
            <span class="ident">operations</span>
        })
    }

    <span class="kw">fn</span> <span class="ident">parse_str</span>(<span class="ident">source</span>: <span class="kw-2">&amp;</span><span class="ident">str</span>, <span class="ident">source_name</span>: <span class="kw-2">&amp;</span><span class="ident">str</span>, <span class="ident">mode</span>: <span class="ident">InterpolationMode</span>) -&gt; <span class="prelude-ty">Result</span><span class="op">&lt;</span><span class="ident">Document</span>,<span class="ident">InterpolationErrorDetails</span><span class="op">&gt;</span> {
        <span class="kw">let</span> <span class="kw-2">mut</span> <span class="ident">tokenizer</span> <span class="op">=</span> <span class="ident">InterpolationTokenizer::new</span>(<span class="ident">source_name</span>, <span class="ident">source</span>.<span class="ident">chars</span>(), <span class="ident">mode</span>);
        <span class="kw">let</span> <span class="ident">result</span> <span class="op">=</span> <span class="ident">Document::parse</span>(<span class="kw-2">&amp;mut</span> <span class="ident">tokenizer</span>);
        <span class="ident">result</span>
    }

    <span class="kw">fn</span> <span class="ident">interpolate</span><span class="op">&lt;</span><span class="ident">Data</span>: <span class="ident">InterpolationObject</span><span class="op">&gt;</span>(<span class="kw-2">&amp;</span><span class="self">self</span>, <span class="ident">source_name</span>: <span class="kw-2">&amp;</span><span class="ident">str</span>, <span class="ident">data</span>: <span class="kw-2">&amp;</span><span class="ident">Data</span>) -&gt; <span class="prelude-ty">Result</span><span class="op">&lt;</span><span class="ident">Vec</span><span class="op">&lt;</span><span class="ident">TextBlock</span><span class="op">&gt;</span>,<span class="ident">InterpolationErrorDetails</span><span class="op">&gt;</span> {


        <span class="kw">let</span> <span class="kw-2">mut</span> <span class="ident">result</span> <span class="op">=</span> <span class="ident">Vec::new</span>();
        <span class="kw">let</span> <span class="kw-2">mut</span> <span class="ident">current_string</span> <span class="op">=</span> <span class="ident">String::new</span>();
        <span class="kw">let</span> <span class="kw-2">mut</span> <span class="ident">current_spans</span> <span class="op">=</span> <span class="ident">Vec::new</span>();
        <span class="kw">let</span> <span class="kw-2">mut</span> <span class="ident">stack</span> <span class="op">=</span> <span class="ident">Vec::new</span>();
        <span class="kw">let</span> <span class="kw-2">mut</span> <span class="ident">italic_mode</span> <span class="op">=</span> <span class="bool-val">false</span>;
        <span class="kw">let</span> <span class="kw-2">mut</span> <span class="ident">bold_mode</span> <span class="op">=</span> <span class="bool-val">false</span>;
        <span class="kw">let</span> <span class="kw-2">mut</span> <span class="ident">list_mode</span> <span class="op">=</span> <span class="bool-val">false</span>;
        <span class="kw">let</span> <span class="kw-2">mut</span> <span class="ident">current_heading</span> <span class="op">=</span> <span class="prelude-val">None</span>;

        <span class="macro">macro_rules!</span> <span class="ident">end_span</span> {
            () =&gt; {
                <span class="kw">if</span> <span class="op">!</span><span class="ident">current_string</span>.<span class="ident">is_empty</span>() {
                    <span class="kw">let</span> <span class="ident">span</span> <span class="op">=</span> <span class="ident">std::mem::take</span>(<span class="kw-2">&amp;mut</span> <span class="ident">current_string</span>);
                    <span class="ident">current_spans</span>.<span class="ident">push</span>(<span class="kw">match</span> (<span class="ident">italic_mode</span>,<span class="ident">bold_mode</span>) {
                        (<span class="bool-val">false</span>,<span class="bool-val">false</span>) =&gt; <span class="ident">TextSpan::Normal</span>(<span class="ident">span</span>),
                        (<span class="bool-val">true</span>,<span class="bool-val">false</span>) =&gt; <span class="ident">TextSpan::Italic</span>(<span class="ident">span</span>),
                        (<span class="bool-val">false</span>,<span class="bool-val">true</span>) =&gt; <span class="ident">TextSpan::Bold</span>(<span class="ident">span</span>),
                        (<span class="bool-val">true</span>,<span class="bool-val">true</span>) =&gt; <span class="ident">TextSpan::BoldItalic</span>(<span class="ident">span</span>)
                    });
                }
            };
        }

        <span class="macro">macro_rules!</span> <span class="ident">reset_span</span> {
            () =&gt; {
                <span class="ident">italic_mode</span> <span class="op">=</span> <span class="bool-val">false</span>;
                <span class="ident">bold_mode</span> <span class="op">=</span> <span class="bool-val">false</span>;                    
            };
        }

        <span class="macro">macro_rules!</span> <span class="ident">end_block</span> {
            () =&gt; {
                <span class="kw">if</span> (<span class="ident">current_heading</span>.<span class="ident">is_some</span>()) <span class="op">|</span><span class="op">|</span> (<span class="ident">current_spans</span>.<span class="ident">len</span>() <span class="op">&gt;</span> <span class="number">0</span>) {
                    <span class="kw">let</span> <span class="ident">heading</span> <span class="op">=</span> <span class="ident">std::mem::take</span>(<span class="kw-2">&amp;mut</span> <span class="ident">current_heading</span>);
                    <span class="kw">let</span> <span class="ident">body</span> <span class="op">=</span> <span class="ident">std::mem::take</span>(<span class="kw-2">&amp;mut</span> <span class="ident">current_spans</span>);
                    <span class="ident">result</span>.<span class="ident">push</span>(<span class="kw">if</span> <span class="ident">list_mode</span> {
                        <span class="ident">TextBlock::SubParagraph</span> {
                            <span class="ident">heading</span>, <span class="ident">body</span>
                        }
                     } <span class="kw">else</span> {
                        <span class="ident">TextBlock::Paragraph</span> {
                            <span class="ident">heading</span>, <span class="ident">body</span>
                        }
                     });
                }
            
            };
        }
        
        <span class="kw">for</span> (<span class="ident">operation</span>,<span class="ident">position</span>) <span class="kw">in</span> <span class="kw-2">&amp;</span><span class="self">self</span>.<span class="ident">operations</span> {

            <span class="macro">macro_rules!</span> <span class="ident">pop</span> {
                () =&gt; {
                    <span class="kw">if</span> <span class="kw">let</span> <span class="prelude-val">Some</span>(<span class="ident">value</span>) <span class="op">=</span> <span class="ident">stack</span>.<span class="ident">pop</span>() {
                        <span class="ident">value</span>
                    } <span class="kw">else</span> {
                        <span class="prelude-val">Err</span>(<span class="ident">InterpolationErrorDetails</span> {
                            <span class="ident">error</span>: <span class="ident">InterpolationError::EmptyStack</span>(<span class="macro">format!</span>(<span class="string">&quot;{:?}&quot;</span>,<span class="ident">operation</span>)),
                            <span class="ident">source_name</span>: <span class="ident">source_name</span>.<span class="ident">to_owned</span>(),
                            <span class="ident">position</span>: <span class="ident">position</span>.<span class="ident">clone</span>(),
                            <span class="ident">full_text</span>: <span class="prelude-val">None</span>
                        })<span class="question-mark">?</span>
                    }
                };
            }

            <span class="macro">macro_rules!</span> <span class="ident">error</span> {
                (<span class="macro-nonterminal">$</span><span class="macro-nonterminal">error</span>: <span class="ident">ident</span>) =&gt; {
                    <span class="prelude-val">Err</span>(<span class="ident">InterpolationErrorDetails</span> {
                        <span class="ident">error</span>: <span class="ident">InterpolationError</span>::<span class="macro-nonterminal">$</span><span class="macro-nonterminal">error</span>,
                        <span class="ident">source_name</span>: <span class="ident">source_name</span>.<span class="ident">to_owned</span>(),
                        <span class="ident">position</span>: <span class="ident">position</span>.<span class="ident">clone</span>(),
                        <span class="ident">full_text</span>: <span class="prelude-val">None</span>
                    })<span class="question-mark">?</span>                    
                };
            }

            <span class="macro">macro_rules!</span> <span class="ident">map_err</span> {
                (<span class="macro-nonterminal">$</span><span class="macro-nonterminal">expr</span>: <span class="ident">expr</span>) =&gt; {
                    <span class="macro-nonterminal">$</span><span class="macro-nonterminal">expr</span>.<span class="ident">map_err</span>(<span class="op">|</span><span class="ident">error</span><span class="op">|</span> <span class="ident">InterpolationErrorDetails</span> {
                        <span class="ident">error</span>,
                        <span class="ident">source_name</span>: <span class="ident">source_name</span>.<span class="ident">to_owned</span>(),
                        <span class="ident">position</span>: <span class="ident">position</span>.<span class="ident">clone</span>(),
                        <span class="ident">full_text</span>: <span class="prelude-val">None</span>
                    })<span class="question-mark">?</span>                    
                };
            }

    
            <span class="kw">match</span> <span class="ident">operation</span> {
                <span class="ident">InterpolationOperation::CreateString</span>(<span class="ident">str</span>) =&gt; {
                    <span class="ident">stack</span>.<span class="ident">push</span>(<span class="ident">InterpolationValue::String</span>(<span class="ident">str</span>.<span class="ident">clone</span>()));
                },
                <span class="ident">InterpolationOperation::CreateNumber</span>(<span class="ident">num</span>) =&gt; {
                    <span class="ident">stack</span>.<span class="ident">push</span>(<span class="ident">InterpolationValue::Number</span>(<span class="kw-2">*</span><span class="ident">num</span>,<span class="bool-val">false</span>));      
                },
                <span class="ident">InterpolationOperation::CreateDice</span>(<span class="ident">dice</span>) =&gt; {
                    <span class="ident">stack</span>.<span class="ident">push</span>(<span class="ident">InterpolationValue::Dice</span>(<span class="ident">dice</span>.<span class="ident">clone</span>().<span class="ident">into</span>(),<span class="bool-val">false</span>));
                },
                <span class="ident">InterpolationOperation::GetVariable</span>(<span class="ident">name</span>) =&gt; {
                    <span class="kw">if</span> <span class="kw">let</span> <span class="prelude-val">Some</span>(<span class="ident">value</span>) <span class="op">=</span> <span class="ident">data</span>.<span class="ident">get_property</span>(<span class="ident">name</span>) {
                        <span class="ident">stack</span>.<span class="ident">push</span>(<span class="ident">value</span>)
                    } <span class="kw">else</span> {
                        <span class="macro">error!</span>(<span class="ident">UnknownVariable</span>)
                    }
                },
                <span class="ident">InterpolationOperation::GetIndex</span>(<span class="ident">index</span>) =&gt; {
                    <span class="kw">let</span> <span class="ident">value</span> <span class="op">=</span> <span class="macro">pop!</span>();
                    <span class="kw">if</span> <span class="kw">let</span> <span class="prelude-val">Some</span>(<span class="ident">value</span>) <span class="op">=</span> <span class="ident">value</span>.<span class="ident">get_index</span>(<span class="ident">index</span>) {
                        <span class="ident">stack</span>.<span class="ident">push</span>(<span class="ident">value</span>)
                    } <span class="kw">else</span> {
                        <span class="macro">error!</span>(<span class="ident">InvalidIndex</span>)
                    }
                    
                },
                <span class="ident">InterpolationOperation::GetProperty</span>(<span class="ident">name</span>) =&gt; {
                    <span class="kw">let</span> <span class="ident">value</span> <span class="op">=</span> <span class="macro">pop!</span>();
                    <span class="kw">if</span> <span class="kw">let</span> <span class="prelude-val">Some</span>(<span class="ident">value</span>) <span class="op">=</span> <span class="ident">value</span>.<span class="ident">get_property</span>(<span class="ident">name</span>) {
                        <span class="ident">stack</span>.<span class="ident">push</span>(<span class="ident">value</span>);
                    } <span class="kw">else</span> {
                        <span class="macro">error!</span>(<span class="ident">UnknownProperty</span>)
                    }                    
                },
                <span class="ident">InterpolationOperation::Negate</span> =&gt; {
                    <span class="kw">let</span> <span class="ident">value</span> <span class="op">=</span> <span class="macro">pop!</span>();
                    <span class="ident">stack</span>.<span class="ident">push</span>(<span class="macro">map_err!</span>(<span class="ident">value</span>.<span class="ident">negate</span>()))
                },
                <span class="ident">InterpolationOperation::Stringify</span> =&gt; {
                    <span class="kw">let</span> <span class="ident">value</span> <span class="op">=</span> <span class="macro">pop!</span>();
                    <span class="ident">stack</span>.<span class="ident">push</span>(<span class="macro">map_err!</span>(<span class="ident">value</span>.<span class="ident">stringify</span>()))  
                },
                <span class="ident">InterpolationOperation::Sign</span> =&gt; {
                    <span class="kw">let</span> <span class="ident">value</span> <span class="op">=</span> <span class="macro">pop!</span>();
                    <span class="ident">stack</span>.<span class="ident">push</span>(<span class="macro">map_err!</span>(<span class="ident">value</span>.<span class="ident">signed</span>()))
                    
                },
                <span class="ident">InterpolationOperation::Multiply</span> =&gt; {
                    <span class="kw">let</span> <span class="ident">rhs</span> <span class="op">=</span> <span class="macro">pop!</span>();
                    <span class="kw">let</span> <span class="ident">lhs</span> <span class="op">=</span> <span class="macro">pop!</span>();
                    <span class="ident">stack</span>.<span class="ident">push</span>(<span class="macro">map_err!</span>(<span class="ident">lhs</span>.<span class="ident">multiply</span>(<span class="kw-2">&amp;</span><span class="ident">rhs</span>)))
                },
                <span class="ident">InterpolationOperation::FloorDivide</span> =&gt; {
                    <span class="kw">let</span> <span class="ident">rhs</span> <span class="op">=</span> <span class="macro">pop!</span>();
                    <span class="kw">let</span> <span class="ident">lhs</span> <span class="op">=</span> <span class="macro">pop!</span>();
                    <span class="ident">stack</span>.<span class="ident">push</span>(<span class="macro">map_err!</span>(<span class="ident">lhs</span>.<span class="ident">divide_floor</span>(<span class="kw-2">&amp;</span><span class="ident">rhs</span>)))
                    
                },
                <span class="ident">InterpolationOperation::CeilingDivide</span> =&gt; {
                    <span class="kw">let</span> <span class="ident">rhs</span> <span class="op">=</span> <span class="macro">pop!</span>();
                    <span class="kw">let</span> <span class="ident">lhs</span> <span class="op">=</span> <span class="macro">pop!</span>();
                    <span class="ident">stack</span>.<span class="ident">push</span>(<span class="macro">map_err!</span>(<span class="ident">lhs</span>.<span class="ident">divide_ceiling</span>(<span class="kw-2">&amp;</span><span class="ident">rhs</span>)))
                    
                },
                <span class="ident">InterpolationOperation::Add</span> =&gt; {
                    <span class="kw">let</span> <span class="ident">rhs</span> <span class="op">=</span> <span class="macro">pop!</span>();
                    <span class="kw">let</span> <span class="ident">lhs</span> <span class="op">=</span> <span class="macro">pop!</span>();
                    <span class="ident">stack</span>.<span class="ident">push</span>(<span class="macro">map_err!</span>(<span class="ident">lhs</span>.<span class="ident">add</span>(<span class="kw-2">&amp;</span><span class="ident">rhs</span>)))
                    
                },
                <span class="ident">InterpolationOperation::Subtract</span> =&gt; {
                    <span class="kw">let</span> <span class="ident">rhs</span> <span class="op">=</span> <span class="macro">pop!</span>();
                    <span class="kw">let</span> <span class="ident">lhs</span> <span class="op">=</span> <span class="macro">pop!</span>();
                    <span class="ident">stack</span>.<span class="ident">push</span>(<span class="macro">map_err!</span>(<span class="ident">lhs</span>.<span class="ident">subtract</span>(<span class="kw-2">&amp;</span><span class="ident">rhs</span>)))
                },
                <span class="ident">InterpolationOperation::Append</span> =&gt; {
                    <span class="kw">let</span> <span class="ident">value</span> <span class="op">=</span> <span class="macro">pop!</span>();
                    <span class="ident">current_string</span>.<span class="ident">push_str</span>(<span class="kw-2">&amp;</span><span class="ident">value</span>.<span class="ident">to_string</span>());                    
                },

                <span class="ident">InterpolationOperation::StartItalic</span> =&gt; {
                    <span class="kw">if</span> <span class="ident">italic_mode</span> {
                        <span class="macro">error!</span>(<span class="ident">TextIsAlreadyItalic</span>)
                    }
                    <span class="macro">end_span!</span>();
                    <span class="ident">italic_mode</span> <span class="op">=</span> <span class="bool-val">true</span>;
                },
                <span class="ident">InterpolationOperation::StartBold</span> =&gt; {
                    <span class="kw">if</span> <span class="ident">bold_mode</span> {
                        <span class="macro">error!</span>(<span class="ident">TextIsAlreadyBold</span>)
                    }
                    <span class="macro">end_span!</span>();
                    <span class="ident">bold_mode</span> <span class="op">=</span> <span class="bool-val">true</span>;
                },
                <span class="ident">InterpolationOperation::EndItalic</span> =&gt; {
                    <span class="kw">if</span> <span class="op">!</span><span class="ident">italic_mode</span> {
                        <span class="macro">error!</span>(<span class="ident">TextIsNotItalic</span>)
                    }
                    <span class="macro">end_span!</span>();
                    <span class="ident">italic_mode</span> <span class="op">=</span> <span class="bool-val">false</span>;
                },
                <span class="ident">InterpolationOperation::EndBold</span> =&gt; {
                    <span class="kw">if</span> <span class="op">!</span><span class="ident">bold_mode</span> {
                        <span class="macro">error!</span>(<span class="ident">TextIsNotBold</span>)
                    }
                    <span class="macro">end_span!</span>();
                    <span class="ident">bold_mode</span> <span class="op">=</span> <span class="bool-val">false</span>;
                },
                <span class="ident">InterpolationOperation::EndBlockStart</span> =&gt; {
                    <span class="macro">end_span!</span>();
                    <span class="kw">if</span> <span class="ident">current_spans</span>.<span class="ident">len</span>() <span class="op">&gt;</span> <span class="number">0</span> {
                        <span class="ident">current_heading</span> <span class="op">=</span> <span class="prelude-val">Some</span>(<span class="ident">current_spans</span>);
                        <span class="ident">current_spans</span> <span class="op">=</span> <span class="ident">Vec::new</span>();
                    }
                    <span class="macro">reset_span!</span>();
                },
                <span class="ident">InterpolationOperation::StartParagraph</span> =&gt; {
                    <span class="macro">end_span!</span>();
                    <span class="macro">end_block!</span>();
                    <span class="macro">reset_span!</span>();
                    <span class="ident">list_mode</span> <span class="op">=</span> <span class="bool-val">false</span>;
                },
                <span class="ident">InterpolationOperation::StartListItem</span> =&gt; {
                    <span class="macro">end_span!</span>();
                    <span class="macro">end_block!</span>();
                    <span class="macro">reset_span!</span>();
                    <span class="ident">list_mode</span> <span class="op">=</span> <span class="bool-val">true</span>;
                },


            }
        }

        <span class="macro">end_span!</span>();
        <span class="macro">end_block!</span>();

        <span class="prelude-val">Ok</span>(<span class="ident">result</span>)
    }


}

<span class="kw">pub</span> <span class="kw">fn</span> <span class="ident">interpolate_str_for_deserialization</span><span class="op">&lt;</span><span class="ident">Data</span>: <span class="ident">InterpolationObject</span><span class="op">&gt;</span>(<span class="ident">source</span>: <span class="kw-2">&amp;</span><span class="ident">str</span>, <span class="ident">source_name</span>: <span class="kw-2">&amp;</span><span class="ident">str</span>, <span class="ident">data</span>: <span class="kw-2">&amp;</span><span class="ident">Data</span>, <span class="ident">show_text_in_error</span>: <span class="ident">bool</span>) -&gt; <span class="prelude-ty">Result</span><span class="op">&lt;</span><span class="ident">String</span>,<span class="ident">InterpolationErrorDetails</span><span class="op">&gt;</span> {
    <span class="kw">match</span> <span class="ident">Document::parse_str</span>(<span class="ident">source</span>, <span class="ident">source_name</span>, <span class="ident">InterpolationMode::DeserializeCreatureCommands</span>).<span class="ident">and_then</span>(<span class="op">|</span><span class="ident">a</span><span class="op">|</span> <span class="ident">a</span>.<span class="ident">interpolate</span>(<span class="ident">source_name</span>, <span class="ident">data</span>)) {
        <span class="prelude-val">Ok</span>(<span class="ident">value</span>) =&gt; {
            <span class="comment">// DeserializeCreatureCommands mode doesn&#39;t allow the commands that would create structured text</span>
            <span class="kw">if</span> <span class="ident">value</span>.<span class="ident">len</span>() <span class="op">==</span> <span class="number">1</span> {
                <span class="kw">if</span> <span class="kw">let</span> <span class="prelude-val">Some</span>(<span class="ident">TextBlock::Paragraph</span>{ <span class="ident">heading</span>: <span class="prelude-val">None</span>, <span class="ident">body</span>: <span class="ident">spans</span>}) <span class="op">=</span> <span class="ident">value</span>.<span class="ident">last</span>() {
                    <span class="kw">if</span> <span class="ident">spans</span>.<span class="ident">len</span>() <span class="op">==</span> <span class="number">1</span> {
                        <span class="kw">if</span> <span class="kw">let</span> <span class="prelude-val">Some</span>(<span class="ident">TextSpan::Normal</span>(<span class="ident">text</span>)) <span class="op">=</span> <span class="ident">spans</span>.<span class="ident">last</span>() {
                            <span class="kw">return</span> <span class="prelude-val">Ok</span>(<span class="ident">text</span>.<span class="ident">clone</span>());
                        }
                    }
                }
            };
            <span class="prelude-val">Err</span>(<span class="ident">InterpolationErrorDetails</span> {
                <span class="ident">error</span>: <span class="ident">InterpolationError::UnexpectedStructuredText</span>,
                <span class="ident">source_name</span>: <span class="ident">source_name</span>.<span class="ident">to_owned</span>(),
                <span class="ident">position</span>: <span class="ident">PositionRange</span> {
                    <span class="ident">start</span>: <span class="ident">Position</span> {
                        <span class="ident">line</span>: <span class="number">0</span>,
                        <span class="ident">column</span>: <span class="number">0</span>
                    },
                    <span class="ident">end</span>: <span class="ident">Position</span> {
                        <span class="ident">line</span>: <span class="number">0</span>,
                        <span class="ident">column</span>: <span class="number">0</span>
                    }
                },
                <span class="ident">full_text</span>: <span class="kw">if</span> <span class="ident">show_text_in_error</span> {
                    <span class="prelude-val">Some</span>(<span class="ident">source</span>.<span class="ident">to_owned</span>())
                } <span class="kw">else</span> {
                    <span class="prelude-val">None</span>
                }
            })
        },
        <span class="prelude-val">Err</span>(<span class="ident">err</span>) =&gt; <span class="kw">if</span> <span class="ident">show_text_in_error</span> {
            <span class="prelude-val">Err</span>(<span class="ident">err</span>.<span class="ident">with_full_text</span>(<span class="ident">source</span>))
        } <span class="kw">else</span> {
            <span class="prelude-val">Err</span>(<span class="ident">err</span>)
        }
    }
}

<span class="kw">pub</span> <span class="kw">fn</span> <span class="ident">interpolate_str_for_statblock</span><span class="op">&lt;</span><span class="ident">Data</span>: <span class="ident">InterpolationObject</span><span class="op">&gt;</span>(<span class="ident">source</span>: <span class="kw-2">&amp;</span><span class="ident">str</span>, <span class="ident">source_name</span>: <span class="kw-2">&amp;</span><span class="ident">str</span>, <span class="ident">data</span>: <span class="kw-2">&amp;</span><span class="ident">Data</span>, <span class="ident">show_text_in_error</span>: <span class="ident">bool</span>) -&gt; <span class="prelude-ty">Result</span><span class="op">&lt;</span><span class="ident">Vec</span><span class="op">&lt;</span><span class="ident">TextBlock</span><span class="op">&gt;</span>,<span class="ident">InterpolationErrorDetails</span><span class="op">&gt;</span> {
    <span class="kw">match</span> <span class="ident">Document::parse_str</span>(<span class="ident">source</span>, <span class="ident">source_name</span>, <span class="ident">InterpolationMode::CalculateStatBlock</span>).<span class="ident">and_then</span>(<span class="op">|</span><span class="ident">a</span><span class="op">|</span> <span class="ident">a</span>.<span class="ident">interpolate</span>(<span class="ident">source_name</span>,<span class="ident">data</span>)) {
        <span class="prelude-val">Ok</span>(<span class="ident">value</span>) =&gt; <span class="prelude-val">Ok</span>(<span class="ident">value</span>),
        <span class="prelude-val">Err</span>(<span class="ident">err</span>) =&gt; <span class="kw">if</span> <span class="ident">show_text_in_error</span> {
            <span class="prelude-val">Err</span>(<span class="ident">err</span>.<span class="ident">with_full_text</span>(<span class="ident">source</span>))
        } <span class="kw">else</span> {
            <span class="prelude-val">Err</span>(<span class="ident">err</span>)
        }
    }
}


<span class="kw">pub</span> <span class="kw">fn</span> <span class="ident">interpolate_simple_markdown_naively</span>(<span class="ident">heading_source</span>: <span class="kw-2">&amp;</span><span class="ident">str</span>, <span class="ident">source</span>: <span class="kw-2">&amp;</span><span class="ident">str</span>, <span class="ident">source_name</span>: <span class="kw-2">&amp;</span><span class="ident">str</span>, <span class="ident">use_sub_block</span>: <span class="ident">bool</span>, <span class="ident">show_text_in_error</span>: <span class="ident">bool</span>) -&gt; <span class="prelude-ty">Result</span><span class="op">&lt;</span><span class="ident">Vec</span><span class="op">&lt;</span><span class="ident">TextBlock</span><span class="op">&gt;</span>,<span class="ident">InterpolationErrorDetails</span><span class="op">&gt;</span> {

    <span class="comment">// simple parsing</span>
    <span class="kw">let</span> <span class="kw-2">mut</span> <span class="ident">current_string</span> <span class="op">=</span> <span class="ident">String::new</span>();
    <span class="kw">let</span> <span class="kw-2">mut</span> <span class="ident">operations</span> <span class="op">=</span> <span class="ident">Vec::new</span>();

    <span class="kw">let</span> <span class="kw-2">mut</span> <span class="ident">chars</span> <span class="op">=</span> <span class="ident">source</span>.<span class="ident">chars</span>().<span class="ident">enumerate</span>().<span class="ident">peekable</span>();
    <span class="kw">let</span> <span class="kw-2">mut</span> <span class="ident">start</span> <span class="op">=</span> <span class="number">0</span>;
    <span class="kw">let</span> <span class="kw-2">mut</span> <span class="ident">end</span> <span class="op">=</span> <span class="number">0</span>;
    <span class="kw">let</span> <span class="kw-2">mut</span> <span class="ident">bold</span> <span class="op">=</span> <span class="bool-val">false</span>;
    <span class="kw">let</span> <span class="kw-2">mut</span> <span class="ident">italic</span> <span class="op">=</span> <span class="bool-val">false</span>;

    <span class="kw">fn</span> <span class="ident">get_position</span>(<span class="ident">start</span>: <span class="ident">usize</span>, <span class="ident">end</span>: <span class="ident">usize</span>) -&gt; <span class="ident">PositionRange</span> {
        <span class="ident">PositionRange</span> {
            <span class="ident">start</span>: <span class="ident">Position</span> {
                <span class="ident">line</span>: <span class="number">1</span>,
                <span class="ident">column</span>: <span class="ident">start</span>
            },
            <span class="ident">end</span>: <span class="ident">Position</span> {
                <span class="ident">line</span>: <span class="number">1</span>,
                <span class="ident">column</span>: <span class="ident">end</span>
            }

        }
    }

    <span class="comment">// push the name on as the heading start</span>
    <span class="kw">if</span> <span class="ident">use_sub_block</span> {
        <span class="ident">operations</span>.<span class="ident">push</span>((<span class="ident">InterpolationOperation::StartListItem</span>,<span class="ident">get_position</span>(<span class="ident">start</span>, <span class="ident">end</span>)));
    } <span class="kw">else</span> {
        <span class="ident">operations</span>.<span class="ident">push</span>((<span class="ident">InterpolationOperation::StartParagraph</span>,<span class="ident">get_position</span>(<span class="ident">start</span>, <span class="ident">end</span>)));
    }
    <span class="ident">operations</span>.<span class="ident">push</span>((<span class="ident">InterpolationOperation::CreateString</span>(<span class="ident">Rc::from</span>(<span class="ident">heading_source</span>)),<span class="ident">get_position</span>(<span class="number">0</span>, <span class="number">0</span>)));
    <span class="ident">operations</span>.<span class="ident">push</span>((<span class="ident">InterpolationOperation::Append</span>,<span class="ident">get_position</span>(<span class="number">0</span>,<span class="number">0</span>)));
    <span class="ident">operations</span>.<span class="ident">push</span>((<span class="ident">InterpolationOperation::EndBlockStart</span>,<span class="ident">get_position</span>(<span class="ident">start</span>, <span class="ident">end</span>)));

    <span class="kw">while</span> <span class="kw">let</span> <span class="prelude-val">Some</span>((<span class="ident">position</span>,<span class="ident">char</span>)) <span class="op">=</span> <span class="ident">chars</span>.<span class="ident">next</span>() {
        <span class="ident">end</span> <span class="op">=</span> <span class="ident">position</span>;
        <span class="kw">match</span> <span class="ident">char</span> {
            <span class="string">&#39;\n&#39;</span> =&gt; {
                <span class="kw">let</span> <span class="ident">use_sub</span> <span class="op">=</span> <span class="kw">if</span> <span class="kw">let</span> <span class="prelude-val">Some</span>((<span class="kw">_</span>,<span class="string">&#39;•&#39;</span>)) <span class="op">=</span> <span class="ident">chars</span>.<span class="ident">peek</span>() {
                    <span class="ident">chars</span>.<span class="ident">next</span>();
                    <span class="bool-val">true</span>
                } <span class="kw">else</span> {
                    <span class="bool-val">false</span>
                };
                <span class="kw">let</span> <span class="ident">new_string</span> <span class="op">=</span> <span class="ident">std::mem::replace</span>(<span class="kw-2">&amp;mut</span> <span class="ident">current_string</span>, <span class="ident">String::new</span>());
                <span class="ident">operations</span>.<span class="ident">push</span>((<span class="ident">InterpolationOperation::CreateString</span>(<span class="ident">Rc::from</span>(<span class="ident">new_string</span>)),<span class="ident">get_position</span>(<span class="ident">start</span>, <span class="ident">end</span>)));
                <span class="ident">start</span> <span class="op">=</span> <span class="ident">end</span>;
                <span class="ident">operations</span>.<span class="ident">push</span>((<span class="ident">InterpolationOperation::Append</span>,<span class="ident">get_position</span>(<span class="ident">start</span>, <span class="ident">end</span>)));
                <span class="kw">if</span> <span class="ident">use_sub</span> {
                    <span class="ident">operations</span>.<span class="ident">push</span>((<span class="ident">InterpolationOperation::StartListItem</span>,<span class="ident">get_position</span>(<span class="ident">start</span>, <span class="ident">end</span>)));
                } <span class="kw">else</span> {

                    <span class="ident">operations</span>.<span class="ident">push</span>((<span class="ident">InterpolationOperation::StartParagraph</span>,<span class="ident">get_position</span>(<span class="ident">start</span>, <span class="ident">end</span>)));
                }
                <span class="ident">operations</span>.<span class="ident">push</span>((<span class="ident">InterpolationOperation::EndBlockStart</span>,<span class="ident">get_position</span>(<span class="ident">start</span>, <span class="ident">end</span>)));
            },
            <span class="string">&#39;*&#39;</span> =&gt; {
                <span class="kw">if</span> <span class="kw">let</span> <span class="prelude-val">Some</span>((<span class="kw">_</span>,<span class="string">&#39;*&#39;</span>)) <span class="op">=</span> <span class="ident">chars</span>.<span class="ident">peek</span>() {
                    <span class="ident">chars</span>.<span class="ident">next</span>();
                    <span class="kw">let</span> <span class="ident">new_string</span> <span class="op">=</span> <span class="ident">std::mem::replace</span>(<span class="kw-2">&amp;mut</span> <span class="ident">current_string</span>, <span class="ident">String::new</span>());
                    <span class="ident">operations</span>.<span class="ident">push</span>((<span class="ident">InterpolationOperation::CreateString</span>(<span class="ident">Rc::from</span>(<span class="ident">new_string</span>)),<span class="ident">get_position</span>(<span class="ident">start</span>,<span class="ident">end</span>)));
                    <span class="ident">start</span> <span class="op">=</span> <span class="ident">end</span>;
                    <span class="ident">operations</span>.<span class="ident">push</span>((<span class="ident">InterpolationOperation::Append</span>,<span class="ident">get_position</span>(<span class="ident">start</span>,<span class="ident">end</span>)));
                    <span class="kw">if</span> <span class="ident">bold</span> {
                        <span class="ident">operations</span>.<span class="ident">push</span>((<span class="ident">InterpolationOperation::EndBold</span>,<span class="ident">get_position</span>(<span class="ident">start</span>,<span class="ident">end</span>)));
                        <span class="ident">bold</span> <span class="op">=</span> <span class="bool-val">false</span>;
                    } <span class="kw">else</span> {
                        <span class="ident">operations</span>.<span class="ident">push</span>((<span class="ident">InterpolationOperation::StartBold</span>,<span class="ident">get_position</span>(<span class="ident">start</span>,<span class="ident">end</span>)));
                        <span class="ident">bold</span> <span class="op">=</span> <span class="bool-val">true</span>;
                    }
                } <span class="kw">else</span> {
                    <span class="ident">current_string</span>.<span class="ident">push</span>(<span class="string">&#39;*&#39;</span>);
                }
            },
            <span class="string">&#39;_&#39;</span> =&gt; {
                <span class="kw">if</span> <span class="kw">let</span> <span class="prelude-val">Some</span>((<span class="kw">_</span>,<span class="string">&#39;_&#39;</span>)) <span class="op">=</span> <span class="ident">chars</span>.<span class="ident">peek</span>() {
                    <span class="ident">chars</span>.<span class="ident">next</span>();
                }
                <span class="kw">let</span> <span class="ident">new_string</span> <span class="op">=</span> <span class="ident">std::mem::replace</span>(<span class="kw-2">&amp;mut</span> <span class="ident">current_string</span>, <span class="ident">String::new</span>());
                <span class="ident">operations</span>.<span class="ident">push</span>((<span class="ident">InterpolationOperation::CreateString</span>(<span class="ident">Rc::from</span>(<span class="ident">new_string</span>)),<span class="ident">get_position</span>(<span class="ident">start</span>,<span class="ident">end</span>)));
                <span class="ident">start</span> <span class="op">=</span> <span class="ident">end</span>;
                <span class="ident">operations</span>.<span class="ident">push</span>((<span class="ident">InterpolationOperation::Append</span>,<span class="ident">get_position</span>(<span class="ident">start</span>,<span class="ident">end</span>)));
                <span class="kw">if</span> <span class="ident">italic</span> {
                    <span class="ident">operations</span>.<span class="ident">push</span>((<span class="ident">InterpolationOperation::EndItalic</span>,<span class="ident">get_position</span>(<span class="ident">start</span>,<span class="ident">end</span>)));
                    <span class="ident">italic</span> <span class="op">=</span> <span class="bool-val">false</span>;
                } <span class="kw">else</span> {
                    <span class="ident">operations</span>.<span class="ident">push</span>((<span class="ident">InterpolationOperation::StartItalic</span>,<span class="ident">get_position</span>(<span class="ident">start</span>,<span class="ident">end</span>)));
                    <span class="ident">italic</span> <span class="op">=</span> <span class="bool-val">true</span>;
                }
            },
            <span class="ident">c</span> =&gt; {
                <span class="ident">current_string</span>.<span class="ident">push</span>(<span class="ident">c</span>);
            }
        }
    };

    <span class="ident">operations</span>.<span class="ident">push</span>((<span class="ident">InterpolationOperation::CreateString</span>(<span class="ident">Rc::from</span>(<span class="ident">current_string</span>)),<span class="ident">get_position</span>(<span class="ident">start</span>, <span class="ident">end</span>)));
    <span class="ident">start</span> <span class="op">=</span> <span class="ident">end</span>;
    <span class="ident">operations</span>.<span class="ident">push</span>((<span class="ident">InterpolationOperation::Append</span>,<span class="ident">get_position</span>(<span class="ident">start</span>, <span class="ident">end</span>)));

    <span class="kw">let</span> <span class="ident">document</span> <span class="op">=</span> <span class="ident">Document</span> {
        <span class="ident">operations</span>
    };

    <span class="kw">match</span> <span class="ident">document</span>.<span class="ident">interpolate</span>(<span class="ident">source_name</span>,<span class="kw-2">&amp;</span>()) {
        <span class="prelude-val">Ok</span>(<span class="ident">value</span>) =&gt; <span class="prelude-val">Ok</span>(<span class="ident">value</span>),
        <span class="prelude-val">Err</span>(<span class="ident">err</span>) =&gt; <span class="kw">if</span> <span class="ident">show_text_in_error</span> {
            <span class="prelude-val">Err</span>(<span class="ident">err</span>.<span class="ident">with_full_text</span>(<span class="ident">source</span>))
        } <span class="kw">else</span> {
            <span class="prelude-val">Err</span>(<span class="ident">err</span>)
        }
    }



}</code></pre></div>
</section><section id="search" class="content hidden"></section></div></main><div id="rustdoc-vars" data-root-path="../../" data-current-crate="monstorr_lib" data-themes="ayu,dark,light" data-resource-suffix="" data-rustdoc-version="1.61.0 (fe5b13d68 2022-05-18)" ></div>
</body></html>